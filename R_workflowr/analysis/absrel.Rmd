---
title: "absrel"
author: "docmanny"
date: "2023-11-08"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Introduction

```{r}
library(tidyverse)
library(ggpubr)
library(ComplexHeatmap)
library(WebGestaltR)
library(ggnewscale)
library(ggrepel)
library(grid)
library(cowplot)
```

```{r data}
df <- read_tsv('../data/absrel_highlight/BatsOnly_LQ_quartile4-branchAttributes.csv')

tt <- read_csv('../data/Myotis_alignments_sequence_map_files_20230622 - Myotis_alignments_sequence_map_files_20230622.csv')

df.lq.bats.ntiles <- read_tsv('../data/lifehistory/manny_mammal_agedata_harmonized.withLQ_hasAli_hasNTiles.tsv')

df.tt <- df  %>% 
  left_join(
    tt,
    by=c('gene' = 'myotis_ali_fn')
  ) %>% 
  mutate(p.val = `Corrected P-value`)
  
all_genes <- df.tt %>% 
  pull(human_gene_name) %>% 
  unique
```

```{r species colors}
our_genomes = c(
  "Myotis_auriculus",
  "Myotis_californicus",
  "Myotis_occultus",
  "Myotis_lucifugus",
  "Myotis_yumanensis",
  "Myotis_volans",
  "Myotis_velifer",
  "Myotis_evotis",
  "Myotis_thysanodes"
)

species_color = ggsci::pal_d3(palette = "category20")(length(our_genomes)+1) %>% 
  set_names(., c(our_genomes, "Other"))

species_color["Myotis_evotis"] = "#17BECF"
species_color["Other"] = "#7F7F7F"
```


```{r Volcano plot}
df.val <- df %>% 
  select(species, gene, LRT, p.val = `Corrected P-value`) %>% 
  filter(!is.na(p.val))
```

```{r stats}
df.val %>% 
  group_by(species) %>% 
  summarize(
    n = n(),
    n.sig = sum(p.val<=0.05)
  )
```


```{r Volcano plot}
df.val %>% 
  ggplot(
    aes(
      x=LRT, 
      y=p.val,
      color=species
    )
  ) +
  geom_point() + 
  facet_wrap(vars(species), scales='free') + 
  theme_pubr() + 
  theme(legend.position = 'none') + 
  labs_pubr()


ggpubr::gghistogram(df.val %>% mutate(p.val=p.val), x="p.val",bins=100) +
  facet_wrap(vars(species)) + 
  scale_y_log10()
  # theme_pubr() + 
  # labs_pubr()

```

```{r}
df.val.geneID <- df.tt %>% 
  filter(p.val<=0.05)

list.geneid <- df.val.geneID %>% 
  select(species, human_gene_name) %>% 
  group_split(species)
list.geneid <- 
  magrittr::set_names(list.geneid, list.geneid %>% sapply(. %>% pull(species) %>% unique)) %>%
  lapply(pull, human_gene_name)
```

```{r}

mat.absrel <- list_to_matrix(list.geneid)

m1 <-  make_comb_mat(mat.absrel)

set_name(m1)

cols_comb_core <- c(
  "000010000" = species_color[['Myotis_lucifugus']],  # myoLuc
  "000000100" = species_color[['Myotis_occultus']],  # myoOcc
  "000100000" = species_color[['Myotis_evotis']],  # myoEvo
  "000000010" = species_color[['Myotis_volans']],  # myoVol
  "001000000" = '#E6AF2E',  # myoBra
  "000001000" = '#816E94',  # myoMyo
  "100000000" = '#3D348B',  # desRot
  "010000000" = '#A01A7D',  # minSch
  "000000001" = '#273E47',  # rhiFer
  "001111110" = 'red',  # panMyo
  "110000001" = 'white',  # notMyo
  "001110110" = 'green',  # neaMyo
  "000110110" = 'blue',  # wesMyo
  "000010100" = 'goldenrod'  # LucOcc
)

unhighlighted <- setdiff(
  # comb_name(m1)[order(comb_size(m1),decreasing = T)],
  comb_name(m1),
  names(cols_comb_core)
)

cols_comb <- c(
  cols_comb_core,
  set_names(
    rep('#000000', times=length(unhighlighted)),
    unhighlighted
  )
)

order_set <- c(
    'Myotis_lucifugus',
    'Myotis_occultus',
    'Myotis_evotis',
    'Myotis_brandtii',
    'Myotis_volans',
    'Myotis_myotis',
    'Desmodus_rotundus',
    'Miniopterus_schreibersii',
    'Rhinolophus_ferrumequinum'
  )


order_cols_core <- match(names(cols_comb_core), names(comb_size(m1))) %>% 
  set_names(., names(cols_comb_core)) %>% 
  .[!is.na(.)]

order_cols = c(
 order_cols_core %>% unname,
 setdiff(order(comb_size(m1),decreasing = T), order_cols_core)
)

cols_set <- c(
  "Desmodus_rotundus" = '#3D348B',
  "Miniopterus_schreibersii" = '#A01A7D',
  "Myotis_brandtii" = '#E6AF2E',
  "Myotis_evotis" = species_color[['Myotis_evotis']],
  "Myotis_lucifugus" = species_color[['Myotis_lucifugus']],
  "Myotis_myotis" = '#816E94',
  "Myotis_occultus" = species_color[['Myotis_occultus']],
  "Myotis_volans" = species_color[['Myotis_volans']],
  "Rhinolophus_ferrumequinum" = '#273E47'
  )
```

```{r full Upset}
UpSet(
  m1,
  set_order = set_order,
  comb_order = order_cols,
  comb_col = cols_comb[comb_name(m1)],
)
```

```{r subset upset}
subset_m <- m1[comb_name(m1) %in% names(cols_comb_core)]
order_cols_sub = c(
 match(names(cols_comb_core), names(comb_size(subset_m))) %>% 
  .[!is.na(.)],
 setdiff(order(comb_size(subset_m),decreasing = T), order_cols_core)
)

u1 <- UpSet(
  subset_m,
  set_order = set_order,
  comb_col = cols_comb[comb_name(subset_m)],
  left_annotation = rowAnnotation(
    set_name = anno_text(
      set_name(subset_m), 
      location = 0.5, 
      just = "center",
      width = max_text_width(set_name(subset_m)) + unit(4, "mm")
    ),
    "Postively-Selected Genes" = anno_barplot(
      -set_size(subset_m), 
      baseline = 0,
      axis_param = list(
        at = c(0, -100, -200, -300, -400),
        labels = c(0, 100, 200, 300, 400),
        labels_rot = 0
        ),
      border = FALSE, 
      gp = gpar(fill = "black"), 
      width = unit(4, "cm")
    )
  ),
  right_annotation = NULL,
  show_row_names=F
)

ht=draw(u1)

```

```{r subset upset with tree}
library(ggtree)
library(treeio)
library(tidytree)
library(MCMCtreeR)
library(dendextend)

timetree <- readMCMCtree('../data/timetree/Run2_real_combined_allGenesAllSpecies/FigTree.tre')$apePhy %>% 
  keep.tip(order_set)


timetree <- timetree %>% ape::rotate(16) %>%  ape::rotate(17)

tt.hclust <- as.hclust(timetree)

phylo_row_dend = as.dendrogram(tt.hclust)

```

```{r}
p.lq <- df.lq.bats.ntiles %>% 
  # mutate(y=0.02 %>% multiply_by(rep(c(1,-1), times=5))) %>%
  ggplot(
    aes(
      x=LQ,
      y=0,
      color=LQ,
      fill=LQ
    )
  ) +
  geom_hline(yintercept=0) +
  geom_point(
    shape = '|',
    size=4,
    alpha=0.5
  ) +
    geom_point(
      data=. %>% filter(has.ali),
    shape = '|',
    size=8,
  ) +
  geom_point(
    data = . %>% 
      filter(
        has.ali,
        quartile==4
      ),
    shape=1,
    size=4
  ) + 
  scale_color_viridis_c(option='D') + 
  ggnewscale::new_scale_color() + 
  geom_text_repel(
    data = . %>% 
      filter(
        has.ali,
        quintile==5
      ),
    aes(
      label=label %>% str_replace_all("_", " "),
      color=label
    ),force = 10, max.overlaps = 1100, direction = 'y',
    hjust=0.5,min.segment.length = 0,
    fontface='italic',
    bg.color='white'
  ) + 
  scale_color_manual('Species', values = cols_set) + 
  # theme_void() +
  labs(x="LQ") + 
  theme_minimal() + 
  labs_pubr() + 
  theme(
    legend.position = 'none',
    axis.line.y=element_blank(),
    axis.text.y=element_blank(),
    axis.ticks.y=element_blank(),
    axis.title.y=element_blank(),
    panel.grid = element_blank()
  )
p.lq
```

```{r}
p.ht <- grid.grabExpr(
  draw(u1),
  width=unit(6, 'in'),
  height=unit(4, 'in')
)
p.tr <- revts(ggtree(timetree) + theme_tree2()) +
  scale_x_continuous(labels=abs)
```



## WebGestaltR

### Prep

```{r sets}
sets = list(
  desRot = extract_comb(m1, '100000000'),
  minSch = extract_comb(m1, '010000000'),
  myoBra = extract_comb(m1, '001000000'),
  myoEvo = extract_comb(m1, '000100000'),
  myoLuc = extract_comb(m1, '000010000'),
  myoMyo = extract_comb(m1, '000001000'),
  myoOcc = extract_comb(m1, '000000100'),
  myoVol = extract_comb(m1, '000000010'),
  rhiFer = extract_comb(m1, '000000001'),
  panMyo = extract_comb(m1, '001111110'),
  notMyo = extract_comb(m1, '110000001'),
  neaMyo = extract_comb(m1, '001110110'),
  wesMyo = extract_comb(m1, '000110110'),
  LucOcc = extract_comb(m1, '000010100')
)
```


```{r dirs}
dir.create('../output/webGestalt/', recursive=T, showWarnings = F)

for (set in names(sets)) {
  opath <- paste0('../output/webGestalt/', set)
  dir.create(opath, recursive=T, showWarnings = F)
  sets[[set]] %>% write_lines(paste0(opath, '/aBSREL-', set, '.txt'))
  all_genes %>% write_lines(paste0(opath, 'aBSREL-allGenes.txt'))
}
```

```{r WebGestaltR Batch, eval=F}

run_ORA <- function(geneSet, refGeneSet, outputDirectory, enrichmentDB, fdrThr, projName){
  WebGestaltR(
    enrichMethod = "ORA",
    enrichDatabase = enrichmentDB,
    organism = "hsapiens",
    interestGene = geneSet,
    interestGeneType = "genesymbol",
    referenceGene = refGeneSet,
    referenceGeneType = "genesymbol",
    maxNum=1000,
    sigMethod="top",
    topThr=100,
    fdrThr=as.numeric(fdrThr),
    reportNum=100,
    isOutput = T,
    outputDirectory = outputDirectory,
    hostName="http://www.webgestalt.org/",
    projectName=projName
  )
}

enrichments <- lapply(
  names(sets)[1],
  function(n, s=sets, a=all_genes, e='pathway_Reactome', f=0.1, p = 'aBSREL'){
    run_ORA(
      # geneSet = s[[n]],
  refGeneSet = a, 
  outputDirectory = paste0('../output/webGestalt/', n), 
  enrichmentDB = e, 
  fdrThr = f, 
  projName = p
  )
  }
)
```

## All Myotis Nodes


