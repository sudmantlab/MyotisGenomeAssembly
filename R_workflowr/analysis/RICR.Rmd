---
title: "RICR"
author: "docmanny"
date: "2023-10-23"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Introduction

So, huge caveat - in order to use the full power of the data I have, I had to use
a different time-calibrated tree (Upham _et al_, 2019) that has everyone for this 
analysis. Thus, the relatedness between bats is messed up because they don't have
our HQ, genome-wide phylo.

```{r}
library(tidyverse)
library(magrittr)
library(ape)
library(tidytree)
library(ggpubr)
library(ggdist)
library(ggtree)
library(tidytree)
library(broom)
library(ggsci)
library(ggrepel)
library(kableExtra)
library(rphylopic)
library(ggnewscale)
library(patchwork)
library(aplot)
```

```{r}
## StackOverflow: 
# https://stackoverflow.com/questions/7549694/add-regression-line-equation-and-r2-on-graph


lm_eqn = function(m) {

  l <- list(a = format(coef(m)[1], digits = 2),
      b = format(abs(coef(m)[2]), digits = 2),
      r2 = format(summary(m)$r.squared, digits = 3));

  if (coef(m)[2] >= 0)  {
    eq <- substitute(italic(y) == a + b %.% italic(x)*", "~~italic(r)^2~"="~r2,l)
  } else {
    eq <- substitute(italic(y) == a - b %.% italic(x)*", "~~italic(r)^2~"="~r2,l)    
  }

  as.character(as.expression(eq));                 
}
```


```{r data}
our_genomes = c(
  "Myotis_auriculus",
  "Myotis_californicus",
  "Myotis_occultus",
  "Myotis_lucifugus",
  "Myotis_yumanensis",
  "Myotis_volans",
  "Myotis_velifer",
  "Myotis_evotis",
  "Myotis_thysanodes"
)

tt.upham <- read_tsv('../data/trees/UphamEtAl2019_harmonizednames.tsv') %>% 
  select(newlab = label, label=submitted_name)
tr.upham <- read.tree('../data/trees/UphamEtAl2019_harmonizednames.nwk')
df.lq <- read_tsv('../data/lifehistory/manny_mammal_agedata_harmonized.withLQ_hasAli.tsv')
# cancerSucceptibility.table <- read_csv('../data/stableTraits/cancerRisk-UphamEtAl2019WithBS_Run1_2.csv')
# sizetable <- read_csv('../data/stableTraits/bodysize-UphamEtAl2019_harmonizednames_withSizeLife_size_concat.csv') %>% 
#   rename(
#     bs.branch.length=branch.length, 
#     bs.brownian=Brownian, 
#     bs.median=Median, 
#     bs.low=X95.CI_Low, 
#     bs.high=X95.CI_High
#   )
# lifetable <- read_csv('../data/stableTraits/life-UphamEtAl2019_harmonizednames_withSizeLife_lifespan_concat.csv') %>% 
#   rename(
#     lifespan.branch.length=branch.length, 
#     lifespan.brownian=Brownian, 
#     lifespan.median=Median, 
#     lifespan.low=X95.CI_Low, 
#     lifespan.high=X95.CI_High
#   )
```

## More LQ 

```{r lq prediction}
p.prediction <- df.lq %>%
  filter(!is.na(Order),
         !is.na(predLife),
         !is.na(lifespan)) %>%
  group_by(Order) %>%
  filter(n_distinct(label) > 20) %>%
  ungroup %>%
  ggplot(
    aes(
      x=lifespan,
      y=predLife,
      color=Order
    )
  )+
  geom_point() +
  labs(x="Lifespan (yrs)",
       y="Predicted Lifespan (yrs)") +
  scale_color_d3(palette = 'category20') +
  facet_wrap(~Order, scales="free") +
  geom_smooth(method = 'lm') +
  theme_pubr() +
  labs_pubr() +
  theme(legend.position = "none")
p.prediction
```

```{r manually add in equations to lq predictions}
df.lq.lm <- df.lq %>% 
  filter(!is.na(Order),
         !is.na(predLife),
         !is.na(lifespan)) %>% 
  group_by(Order) %>% 
  filter(n_distinct(label) > 20) %>% 
  ungroup %>%
  nest(data=-Order) %>% 
  mutate(
    model = purrr::map(data, ~ lm(predLife ~ lifespan, .x)),
    lm.clean = purrr::map(model, tidy),
    lm.glance = purrr::map(model, glance),
    equation = sapply(model, lm_eqn)
  ) %>% 
  unnest(lm.glance)


p.prediction.withEq <- p.prediction + 
  geom_text(
    data= df.lq.lm, #%>% 
      # select(Order, data, equation) %>% 
      # unnest(data) %>% 
      # group_by(Order) %>% 
      # mutate(predLife = max(predLife),
      #        lifespan = min(lifespan)) %>% 
      # select(Order, lifespan, predLife, equation) %>% 
      # distinct %>% 
      # ungroup,
    aes(
      x=-Inf,
      y=Inf,
      label=equation
    ),
    hjust=0,
    vjust=1,
    parse=T
  )

p.prediction.withEq
```

```{r R2 line plot}

phylopic.codes <- c(
  'Artiodactyla' = 'dc4c0e07-611f-41d0-b2fa-8c5bc3a22fba',
  'Carnivora' = 'b2dcd44f-1fb8-490e-b016-8279eb328f46',
  'Didelphimorphia' = '162f2753-b795-4ecd-890a-2c6a2ff94ff6',
  'Rodentia' = 'c4572239-3b7c-4259-8049-3f44e6d52e6f',
  'Primates' = 'eccbb404-c99f-41f9-8785-01a7f57f1269',
  'Diprotodontia' = '0904270e-b105-46e0-b81f-c4911d47d467',
  'Cetacea' = '41158ddc-5aa9-41ef-99f9-99c3c10f1847',
  # 'Chiroptera' = '18bfd2fc-f184-4c3a-b511-796aafcc70f6',
  'Chiroptera' = '21180755-3394-40bf-93eb-810954c0f7ba',
  'Soricomorpha' = 'f83c6893-f0ed-4ec4-b558-aa774c5c9b5b',
  'Dasyuromorphia' = '9f505e8e-c431-4738-900d-600b99057b51'
)


p.r2line <- df.lq.lm %>%
  mutate(uid = phylopic.codes[Order]) %>% 
  arrange(r.squared) %>% 
  mutate(y=0.02 %>% multiply_by(rep(c(1,-1), times=5))) %>%
  ggplot(
    aes(
      x=r.squared,
      y=0,
      color=Order,
      fill=Order
    )
  ) +
  geom_hline(yintercept=0) +
  geom_point(
    shape = '|',
    size=8,
  ) +
  geom_phylopic(
    aes(
      y=y,
      uuid=uid
    ),
    size=0.03
  )  +
  # theme_void() +
   coord_fixed(
     ylim=c(-0.03,0.03),
     xlim=c(0,0.8)
   ) +
  labs(x=expression(paste(R^2))) + 
  theme_minimal() + 
  labs_pubr() + 
  theme(
    legend.position = 'none',
    axis.line.y=element_blank(),
    axis.text.y=element_blank(),
    axis.ticks.y=element_blank(),
    axis.title.y=element_blank(),
    panel.grid = element_blank()
  )

p.r2line
```


## StableTraits

```{r StableTraits Trees}

life.anc <- read_tsv('../data/stableTraits/UphamEtAl2019_harmonizednames_withSizeLifeLn_life_concat.ancstates') %>% 
      filter(!str_starts(Parameter, 'stable')) %>% 
  rename(
    label=Parameter,
    lnLife.brownian=Brownian, 
    lnLife.median=Median, 
    lnLife.low=`95%CI_Low`, 
    lnLife.high=`95%CI_High`
  )

tr.life <- read.tree('../data/stableTraits/UphamEtAl2019_harmonizednames_withSizeLifeLn_life_concat.sqchange_tree') #%>% 
  # as.treedata() %>% 
  # full_join(
  #   life.anc,
  #   by=c(label='Parameter')
  # )

tr.size <- read.tree('../data/stableTraits/UphamEtAl2019_harmonizednames_withSizeLifeLn_size_concat.sqchange_tree')

size.anc <- read_tsv('../data/stableTraits/UphamEtAl2019_harmonizednames_withSizeLifeLn_size_concat.ancstates') %>% 
      filter(!str_starts(Parameter, 'stable')) %>% 
  rename(
    label=Parameter,
    lnSize.brownian=Brownian, 
    lnSize.median=Median, 
    lnSize.low=`95%CI_Low`, 
    lnSize.high=`95%CI_High`
  )

tr.og.size <- read.tree('../data/stableTraits/UphamEtAl2019_harmonizednames_withSizeLifeLn_size_concat.tree')

# shared = intersect(tr.life$tip.label, tr.size$tip.label)
# 
# length(shared)
# length(tr.life$tip.label)
# length(tr.size$tip.label)
# 
# comparison <- comparePhylo(
#   x=tr.life,
#   y=tr.size
# )

tr.life %>% as_tibble %>% full_join(tr.size %>% as_tibble, by='label') %>% filter(parent.x != parent.y)

tr.sizedata <- tr.size %>% 
  full_join(size.anc)

tr.lifedata <- tr.life %>% 
  full_join(life.anc)

tr.sizelife <- tr.og.size %>% 
  as.treedata %>% 
  full_join(
    size.anc
  ) %>%
  full_join(
    life.anc
  ) %>% 
  full_join(
    tr.lifedata %>% as_tibble %>% select(label,life.branch.length=branch.length)
  ) %>% 
  full_join(
    tr.sizedata %>% as_tibble %>% select(label,size.branch.length=branch.length)
  )

### NOTE: Idionycteris_phyllotis is an artifact
tr.sizedata <- tr.sizedata %>% 
  tidytree::drop.tip('Idionycteris_phyllotis')
tr.lifedata <- tr.lifedata %>% 
  tidytree::drop.tip('Idionycteris_phyllotis')
tr.sizelife <- tr.sizelife %>% 
  tidytree::drop.tip('Idionycteris_phyllotis')

```

```{r LQ estimation across the tree}
lq.lm <- lm(
  lifespan ~ size, 
  df.lq %>% 
    filter(Order != "Chiroptera") %>% 
    select(size, lifespan) %>% 
    mutate_all(log)
)

tr.sizelife.lq <- augment(
  lq.lm, 
  newdata = tr.sizelife %>% as_tibble %>% mutate(size=lnSize.median)
) %>% 
  mutate(predLife.median = .fitted) %>% 
  select(-.fitted)

tr.sizelife.lq <-   augment(
  lq.lm, 
  newdata = tr.sizelife.lq %>% mutate(size=lnSize.low)
) %>% 
  mutate(predLife.low = .fitted)  %>% 
  select(-.fitted)

tr.sizelife.lq <- augment(
  lq.lm, 
  newdata = tr.sizelife.lq %>% mutate(size=lnSize.high)
) %>% 
  mutate(predLife.high = .fitted) %>% 
  select(-.fitted) 

tr.sizelife.lq <- augment(
  lq.lm, 
  newdata = tr.sizelife.lq %>% mutate(size=size.branch.length)
) %>% 
  mutate(predLife.branch.length = .fitted) %>% 
  select(-.fitted)%>% 
  mutate(
    life.median = exp(lnLife.median), 
    life.low = exp(lnLife.low), 
    life.high = exp(lnLife.high), 
    predLife.median = exp(predLife.median), 
    predLife.low = exp(predLife.low), 
    predLife.high = exp(predLife.high), 
    LQ.median = life.median/predLife.median,
    LQ.low = life.median/predLife.low,
    LQ.high = life.median/predLife.high,
    LQ.branch.length = life.branch.length/predLife.branch.length
  ) %>% 
  as.treedata()

tr.sizelife.lq@phylo$tip.label=tr.sizelife.lq@extraInfo %>% filter(!str_detect(label.y, '\\d')) %>% pull(label.y)
```

## Range Plots

```{r scales}
size.scale <- tr.sizedata %>% as_tibble %>% pull(lnSize.median) %>% unique %>% as.numeric() %>% sort
size.scale.min <- size.scale[1]
size.scale.max <- size.scale[length(size.scale)]
get.size.color <- function(n, scale = size.scale){
  scale.colors = viridis::viridis(n=length(scale)) %>% 
    set_names(., as.character(scale))
  scale.colors[as.character(n)]
}

lifespan.scale <- tr.lifedata %>% as_tibble %>% pull(lnLife.median) %>% unique %>% as.numeric() %>% sort
lifespan.scale.min <- lifespan.scale[1]
lifespan.scale.max <- lifespan.scale[length(lifespan.scale)]
get.lifespan.color <- function(n, scale = lifespan.scale){
  scale.colors = viridis::viridis(n=length(scale), option = "C") %>% 
    set_names(., as.character(scale))
  scale.colors[as.character(n)]
}

LQ.scale <- tr.sizelife.lq %>% as_tibble %>% pull(LQ.median) %>% unique %>% as.numeric() %>% sort
LQ.scale.min <- LQ.scale[1]
LQ.scale.max <- LQ.scale[length(LQ.scale)]
get.LQ.color <- function(n, scale = LQ.scale){
  scale.colors = viridis::viridis(n=length(scale), option = "C") %>% 
    set_names(., as.character(scale))
  scale.colors[as.character(n)]
}

size.scale.expanded <- c(
  tr.sizedata %>% as_tibble %>% pull(lnSize.median),
  tr.sizedata %>% as_tibble %>% pull(lnSize.low),
  tr.sizedata %>% as_tibble %>% pull(lnSize.high)
) %>% unique %>% as.numeric() %>% sort
size.scale.expanded.min <- size.scale.expanded[1]
size.scale.expanded.max <- size.scale.expanded[length(size.scale.expanded)]

lifespan.scale.expanded <- c(
  tr.lifedata %>% as_tibble %>% pull(lnLife.median),
  tr.lifedata %>% as_tibble %>% pull(lnLife.low),
  tr.lifedata %>% as_tibble %>% pull(lnLife.high)
)  %>% unique %>% as.numeric() %>% sort
lifespan.scale.expanded.min <- lifespan.scale.expanded[1]
lifespan.scale.expanded.max <- lifespan.scale.expanded[length(lifespan.scale.expanded)]

LQ.scale.expanded <- c(
  tr.sizelife.lq %>% as_tibble %>% pull(LQ.median),
  tr.sizelife.lq %>% as_tibble %>% pull(LQ.low),
  tr.sizelife.lq %>% as_tibble %>% pull(LQ.high)
)  %>% unique %>% as.numeric() %>% sort
LQ.scale.expanded.min <- lifespan.scale.expanded[1]
LQ.scale.expanded.max <- lifespan.scale.expanded[length(lifespan.scale.expanded)]
```

### Body Size

#### Bats

```{r range plot size - bats}
p.bodysize.bats <- tr.sizedata  %>% 
  tidytree::tree_subset(MRCA(tr.sizedata, 'Myotis_lucifugus', 'Pteropus_vampyrus'), levels_back = 0) %>%
  as_tibble %>% 
  arrange(lnSize.median) %>% 
  mutate(
    size.median = exp(lnSize.median),
    size.low = exp(lnSize.low),
    size.high = exp(lnSize.high)
  ) %>% 
  mutate(label = factor(label, levels=label)) %>% 
  ggplot(
    aes(
      y=label,
      # x=bs.median, 
      # xmin=bs.low,
      # xmax=bs.high
      x=size.median, 
      xmin=size.low,
      xmax=size.high
      )
  ) +
  geom_pointrange(size=0.5) +
  geom_point(aes(color=lnSize.median), size=1) +
  geom_point(aes(x=size.low, color=lnSize.low), size=1.5, stroke=2, pch="[") +
  geom_point(aes(x=size.high, color=lnSize.high), size=1.5, stroke=2, pch="]") +
  scale_color_distiller(limits=c(size.scale.expanded.min, size.scale.expanded.max), 
                        palette = "Blues", 
                        direction = 1,
                        guide = guide_colorbar(
                          title="Body size (log)",
                          title.theme =  element_text(size = 6, face = "bold", colour = "black"),
                          title.position = "top",
                          title.hjust = 0.5
                          )
                        ) +
  labs(
    x="Body size (log)",
    y="Node"
  ) + 
  theme_pubr()+
  labs_pubr() + 
  theme(
    text = element_text(face = "plain", 
                        colour = "black", lineheight = 0.9, 
                        hjust = 0.5, vjust = 0.5, angle = 0, margin = margin(), 
                        debug = FALSE), 
    axis.text = element_text(size = 6, 
                               colour = "black", face = "bold"),
    axis.title = element_text(size = 8, 
                              colour = "black", face = "bold"),
    plot.title = element_text(size = 8, 
                              colour = "black", lineheight = 1, face = "bold"), 
    legend.text = element_text(size = 6, 
                               face = "plain", colour = "black"),
    legend.position = "bottom"
  )
```

#### Myotis

```{r range plot size - Myotis}
p.bodysize.myotis <- tr.sizedata  %>% 
  tidytree::tree_subset(MRCA(tr.sizedata, 'Myotis_lucifugus', 'Nycticeius_humeralis'), levels_back = 0) %>%
  as_tibble %>% 
  arrange(lnSize.median) %>% 
  mutate(
    size.median = exp(lnSize.median),
    size.low = exp(lnSize.low),
    size.high = exp(lnSize.high)
  ) %>% 
  mutate(label = factor(label, levels=label)) %>% 
  ggplot(
    aes(
      y=label,
      # x=bs.median, 
      # xmin=bs.low,
      # xmax=bs.high
      x=lnSize.median, 
      xmin=lnSize.low,
      xmax=lnSize.high
      )
  ) +
  geom_pointrange(size=0.5, stroke=0.1) +
  geom_point(aes(color=lnSize.median), size=0.5) +
  # geom_point(aes(x=lnSize.low, color=lnSize.low), size=1.5, stroke=2, pch="[") +
  # geom_point(aes(x=lnSize.high, color=lnSize.high), size=1.5, stroke=2, pch="]") +
  scale_color_distiller(limits=c(size.scale.expanded.min, size.scale.expanded.max), 
                        palette = "Blues", 
                        direction = 1,
                        guide = guide_colorbar(
                          title="Body size (log)",
                          title.theme =  element_text(size = 6, face = "bold", colour = "black"),
                          title.position = "top",
                          title.hjust = 0.5
                          )
                        ) +
  labs(
    x="Body size (log)",
    y="Node"
  ) + 
  theme_pubr()+
  labs_pubr() + 
  theme(
    text = element_text(face = "plain", 
                        colour = "black", lineheight = 0.9, 
                        hjust = 0.5, vjust = 0.5, angle = 0, margin = margin(), 
                        debug = FALSE), 
    axis.text = element_text(size = 6, 
                               colour = "black", face = "bold"),
    axis.title = element_text(size = 8, 
                              colour = "black", face = "bold"),
    plot.title = element_text(size = 8, 
                              colour = "black", lineheight = 1, face = "bold"), 
    legend.text = element_text(size = 6, 
                               face = "plain", colour = "black"),
    legend.position = "bottom"
  )
p.bodysize.myotis
```

### Lifespan

#### Bats

```{r rangePlot Lifespan - Bats}
p.lifespan.bats <- tr.lifedata %>%
  tidytree::tree_subset(MRCA(tr.lifedata, 'Myotis_lucifugus', 'Pteropus_vampyrus'), levels_back = 0) %>%
  as_tibble %>% 
  arrange(lnLife.median) %>% 
  mutate(
    life.median = exp(lnLife.median),
    life.low = exp(lnLife.low),
    life.high = exp(lnLife.high)
  ) %>% 
  mutate(label = factor(label, levels=label)) %>% 
  ggplot(
    aes(
      y=label,
      # x=lifespan.median, 
      # xmin=lifespan.low,
      # xmax=lifespan.high
      x=life.median, 
      xmin=life.low,
      xmax=life.high
      )
  ) +
  geom_pointrange(size=0.5, stroke=0.5) +
  geom_point(aes(color=lnLife.median), size=0.5) +
  # geom_point(aes(x=life.low, color=lnLife.low), size=1.5, stroke=2, pch="[") +
  # geom_point(aes(x=life.high, color=lnLife.high), size=1.5, stroke=2, pch="]") +
  scale_color_distiller(
    palette = "Reds", direction = 1,
    guide = guide_colorbar(
      title="Lifespan (yrs)",
      title.theme =  element_text(size = 6, face = "bold", colour = "black"),
      title.position = "top",
      title.hjust = 0.5
    )
  ) + 
  labs(
    x="Lifespan (log)",
    y="Node"
  ) + 
  theme_pubr()+
  labs_pubr() + 
  theme(
    text = element_text(face = "plain", 
                        colour = "black", lineheight = 0.9, 
                        hjust = 0.5, vjust = 0.5, angle = 0, margin = margin(), 
                        debug = FALSE), 
    axis.text = element_text(size = 6, 
                               colour = "black", face = "bold"),
    axis.title = element_text(size = 8, 
                              colour = "black", face = "bold"),
    plot.title = element_text(size = 8, 
                              colour = "black", lineheight = 1, face = "bold"), 
    legend.text = element_text(size = 6, 
                               face = "plain", colour = "black"),
    legend.position = "bottom"
  )
p.lifespan.bats
```

#### Myotis

```{r rangePlot Lifespan - Myotis}
p.lifespan.myotis <- tr.lifedata %>%
  tidytree::tree_subset(MRCA(tr.lifedata, 'Myotis_lucifugus', 'Nycticeius_humeralis'), levels_back = 0) %>%
  as_tibble %>% 
  arrange(lnLife.median) %>% 
  mutate(
    life.median = exp(lnLife.median),
    life.low = exp(lnLife.low),
    life.high = exp(lnLife.high)
  ) %>% 
  mutate(label = factor(label, levels=label)) %>% 
  ggplot(
    aes(
      y=label,
      # x=lifespan.median, 
      # xmin=lifespan.low,
      # xmax=lifespan.high
      x=life.median, 
      xmin=life.low,
      xmax=life.high
      )
  ) +
  geom_pointrange(size=0.5, stroke=0.5) +
  geom_point(aes(color=life.median), size=0.5) +
  # geom_point(aes(x=life.low, color=life.low), size=1.5, stroke=2, pch="[") +
  # geom_point(aes(x=life.high, color=life.high), size=1.5, stroke=2, pch="]") +
  scale_color_distiller(
    palette = "Reds", direction = 1,
    guide = guide_colorbar(
      title="Lifespan (yrs)",
      title.theme =  element_text(size = 6, face = "bold", colour = "black"),
      title.position = "top",
      title.hjust = 0.5
    )
  ) + 
  labs(
    x="Lifespan (log)",
    y="Node"
  ) + 
  theme_pubr()+
  labs_pubr() + 
  theme(
    text = element_text(face = "plain", 
                        colour = "black", lineheight = 0.9, 
                        hjust = 0.5, vjust = 0.5, angle = 0, margin = margin(), 
                        debug = FALSE), 
    axis.text = element_text(size = 6, 
                               colour = "black", face = "bold"),
    axis.title = element_text(size = 8, 
                              colour = "black", face = "bold"),
    plot.title = element_text(size = 8, 
                              colour = "black", lineheight = 1, face = "bold"), 
    legend.text = element_text(size = 6, 
                               face = "plain", colour = "black"),
    legend.position = "bottom"
  )
p.lifespan.myotis
```

### LQ

#### Bats

```{r rangePlot LQ - Bats, include=F}
p.LQ.bats <- tr.sizelife.lq %>%
  tidytree::tree_subset(MRCA(tr.sizelife.lq, 'Myotis_lucifugus', 'Pteropus_vampyrus'), levels_back = 0) %>%
  as_tibble %>% 
  arrange(LQ.median) %>% 
  mutate(label = factor(label, levels=label)) %>% 
  ggplot(
    aes(
      y=label,
      x=LQ.median, 
      xmin=LQ.low,
      xmax=LQ.high
      )
  ) +
  geom_pointrange(size=0.5) +
  geom_point(aes(color=LQ.median), size=1) +
  geom_point(aes(x=LQ.low, color=LQ.low), size=1.5, stroke=2, pch="[") +
  geom_point(aes(x=LQ.high, color=LQ.high), size=1.5, stroke=2, pch="]") +
  scale_color_viridis_c(
    option = 'D',
    guide = guide_colorbar(
      title="LQ",
      title.theme =  element_text(size = 6, face = "bold", colour = "black"),
      title.position = "top",
      title.hjust = 0.5
    )
  ) +
  labs(
    x="LQ",
    y="Node"
  ) + 
  theme_pubr()+
  labs_pubr() + 
  theme(
    text = element_text(face = "plain", 
                        colour = "black", lineheight = 0.9, 
                        hjust = 0.5, vjust = 0.5, angle = 0, margin = margin(), 
                        debug = FALSE), 
    axis.text = element_text(size = 6, 
                               colour = "black", face = "bold"),
    axis.title = element_text(size = 8, 
                              colour = "black", face = "bold"),
    plot.title = element_text(size = 8, 
                              colour = "black", lineheight = 1, face = "bold"), 
    legend.text = element_text(size = 6, 
                               face = "plain", colour = "black"),
    legend.position = "bottom"
  )
p.LQ.bats
```

#### Myotis

```{r rangePlot LQ - Myotis, include=F}
p.LQ.myotis <- tr.sizelife.lq %>%
  tidytree::tree_subset(MRCA(tr.sizelife.lq, 'Myotis_lucifugus', 'Nycticeius_humeralis'), levels_back = 0) %>%
  as_tibble %>% 
  arrange(LQ.median) %>% 
  mutate(label = factor(label, levels=label)) %>% 
  ggplot(
    aes(
      y=label,
      x=LQ.median, 
      xmin=LQ.low,
      xmax=LQ.high
      )
  ) +
  geom_pointrange(size=0.5) +
  geom_point(aes(color=LQ.median), size=1) +
  geom_point(aes(x=LQ.low, color=LQ.low), size=1.5, stroke=2, pch="]") +
  geom_point(aes(x=LQ.high, color=LQ.high), size=1.5, stroke=2, pch="[") +
  scale_color_viridis_c(
    option = 'D',
    guide = guide_colorbar(
      title="LQ",
      title.theme =  element_text(size = 6, face = "bold", colour = "black"),
      title.position = "top",
      title.hjust = 0.5
    )
  ) +
  labs(
    x="LQ",
    y="Node"
  ) + 
  theme_pubr()+
  labs_pubr() + 
  theme(
    text = element_text(face = "plain", 
                        colour = "black", lineheight = 0.9, 
                        hjust = 0.5, vjust = 0.5, angle = 0, margin = margin(), 
                        debug = FALSE), 
    axis.text = element_text(size = 6, 
                               colour = "black", face = "bold"),
    axis.title = element_text(size = 8, 
                              colour = "black", face = "bold"),
    plot.title = element_text(size = 8, 
                              colour = "black", lineheight = 1, face = "bold"), 
    legend.text = element_text(size = 6, 
                               face = "plain", colour = "black"),
    legend.position = "bottom"
  )

p.LQ.myotis
```

```{r Time tree - all mammals}
### Lifespan ###

p.tree.time <- tr.upham %>% 
  ggtree(
    # aes(color=lnLife.median)
  ) + 
  geom_highlight(node=MRCA(tr.upham, 'Myotis_lucifugus', 'Pteropus_vampyrus'), fill='gold') +
  ggtree::geom_cladelab(node=MRCA(tr.upham, 'Myotis_lucifugus', 'Pteropus_vampyrus'), label = 'Chiroptera') + 
  geom_highlight(node=MRCA(tr.upham, 'Balaena_mysticetus', 'Phocoena_phocoena'), fill='lightgreen') +
  ggtree::geom_cladelab(node=MRCA(tr.upham, 'Balaena_mysticetus', 'Phocoena_phocoena'), label = 'Cetacea') + 
  geom_highlight(node=MRCA(tr.upham, 'Lepilemur_leucopus', 'Homo_sapiens')) +
  ggtree::geom_cladelab(node=MRCA(tr.upham, 'Lepilemur_leucopus', 'Homo_sapiens'), label = 'Primata') + 
  geom_highlight(node=MRCA(tr.upham, 'Procavia_capensis', 'Loxodonta_africana'), fill='beige') +
  ggtree::geom_cladelab(node=MRCA(tr.upham, 'Procavia_capensis', 'Loxodonta_africana'), label = 'Paenungulata') + 
  theme_tree2()+
  theme(
    legend.position = 'bottom',
    legend.direction = 'horizontal'
  ) + 
  # scale_color_distiller(
  #   palette = "Reds", direction = 1,
  #   guide = guide_colorbar(
  #     title="Lifespan (log(y))",
  #     title.theme =  element_text(size = 6, face = "bold", colour = "black"),
  #     title.position = "top",
  #     title.hjust = 0.5
  #   )
  # ) + 
  xlim(c(NA,400))
p.tree.time
```

```{r Body size evolution - all mammals}
### Body Size ###

p.tree.size <- tr.sizedata %>% 
  ggtree(
    aes(color=as.numeric(lnSize.median))
  ) + 
  geom_highlight(node=MRCA(tr.lifedata, 'Myotis_lucifugus', 'Pteropus_vampyrus'), fill='gold') +
  ggtree::geom_cladelab(node=MRCA(tr.lifedata, 'Myotis_lucifugus', 'Pteropus_vampyrus'), label = 'Bats', align=T) + 
  geom_highlight(node=MRCA(tr.lifedata, 'Balaena_mysticetus', 'Phocoena_phocoena'), fill='lightgreen') +
  ggtree::geom_cladelab(node=MRCA(tr.lifedata, 'Balaena_mysticetus', 'Phocoena_phocoena'), label = 'Whales', align=T) + 
  geom_highlight(node=MRCA(tr.lifedata, 'Lepilemur_leucopus', 'Homo_sapiens')) +
  ggtree::geom_cladelab(node=MRCA(tr.lifedata, 'Lepilemur_leucopus', 'Homo_sapiens'), label = 'Primates', align=T) + 
  geom_highlight(node=MRCA(tr.lifedata, 'Procavia_capensis', 'Loxodonta_africana'), fill='beige') +
  ggtree::geom_cladelab(node=MRCA(tr.lifedata, 'Procavia_capensis', 'Loxodonta_africana'), label = 'Elephants', align=T) +
  theme(
    legend.position = 'bottom',
    legend.direction = 'horizontal'
  ) + 
  scale_color_distiller(
    palette = "Blues", direction = 1,
    guide = guide_colorbar(
      title="Body Size (log(g))",
      title.theme =  element_text(size = 15, face = "bold", colour = "black"),
      title.position = "top",
      title.hjust = 0.5
    )
  ) + 
  xlim(c(NA,1300))
p.tree.size
```

```{r Lifespan evolution - all mammals}
### Lifespan ###

p.tree.life <- tr.lifedata %>% 
  ggtree(
    aes(color=lnLife.median)
  ) + 
  geom_highlight(node=MRCA(tr.lifedata, 'Myotis_lucifugus', 'Pteropus_vampyrus'), fill='gold') +
  ggtree::geom_cladelab(node=MRCA(tr.lifedata, 'Myotis_lucifugus', 'Pteropus_vampyrus'), label = 'Chiroptera', align=T) + 
  geom_highlight(node=MRCA(tr.lifedata, 'Balaena_mysticetus', 'Phocoena_phocoena'), fill='lightgreen') +
  ggtree::geom_cladelab(node=MRCA(tr.lifedata, 'Balaena_mysticetus', 'Phocoena_phocoena'), label = 'Cetacea', align=T) + 
  geom_highlight(node=MRCA(tr.lifedata, 'Lepilemur_leucopus', 'Homo_sapiens')) +
  ggtree::geom_cladelab(node=MRCA(tr.lifedata, 'Lepilemur_leucopus', 'Homo_sapiens'), label = 'Primata', align=T) + 
  geom_highlight(node=MRCA(tr.lifedata, 'Procavia_capensis', 'Loxodonta_africana'), fill='beige') +
  ggtree::geom_cladelab(node=MRCA(tr.lifedata, 'Procavia_capensis', 'Loxodonta_africana'), label = 'Paenungulata', align=T) + 
  theme(
    legend.position = 'bottom',
    legend.direction = 'horizontal'
  ) + 
  scale_color_distiller(
    palette = "Reds", direction = 1,
    guide = guide_colorbar(
      title="Lifespan (log(y))",
      title.theme =  element_text(size = 15, face = "bold", colour = "black"),
      title.position = "top",
      title.hjust = 0.5
    )
  ) + 
  xlim(c(NA,400))
p.tree.life
```

```{r Lifespan evolution - all mammals flipped}
### Lifespan ###
d.tree.life <- p.tree.life$data

d.tree.life$x <- max(d.tree.life$x) - d.tree.life$x

p.tree.life.flipped <- ggplot(data=d.tree.life) + 
  geom_tree(aes(color=lnLife.median)) + 
  theme_tree() + 
  geom_highlight(node=MRCA(tr.lifedata, 'Myotis_lucifugus', 'Pteropus_vampyrus'), fill='gold') +
  geom_highlight(node=MRCA(tr.lifedata, 'Balaena_mysticetus', 'Phocoena_phocoena'), fill='lightgreen') +
  geom_highlight(node=MRCA(tr.lifedata, 'Lepilemur_leucopus', 'Homo_sapiens')) +
  geom_highlight(node=MRCA(tr.lifedata, 'Procavia_capensis', 'Loxodonta_africana'), fill='beige') +
  theme(
    legend.position = 'bottom',
    legend.direction = 'horizontal'
  ) + 
  scale_color_distiller(
    palette = "Reds", direction = 1,
    guide = guide_colorbar(
      title="Lifespan (log(y))",
      title.theme =  element_text(size = 15, face = "bold", colour = "black"),
      title.position = "top",
      title.hjust = 0.5
    )
  )
p.tree.life.flipped
```

```{r Lifespan evolution - all mammals Circular, eval=F, include=F}
### Lifespan ###

p.tree.life.circ <- tr.lifedata %>% 
  ggtree(
    layout='circular',
    aes(color=lnLife.median)
  ) + 
  geom_highlight(node=MRCA(tr.lifedata, 'Myotis_lucifugus', 'Pteropus_vampyrus'), fill='gold') +
  ggtree::geom_cladelab(node=MRCA(tr.lifedata, 'Myotis_lucifugus', 'Pteropus_vampyrus'), label = 'Chiroptera') + 
  geom_highlight(node=MRCA(tr.lifedata, 'Balaena_mysticetus', 'Phocoena_phocoena'), fill='lightgreen') +
  ggtree::geom_cladelab(node=MRCA(tr.lifedata, 'Balaena_mysticetus', 'Phocoena_phocoena'), label = 'Cetacea') + 
  geom_highlight(node=MRCA(tr.lifedata, 'Lepilemur_leucopus', 'Homo_sapiens')) +
  ggtree::geom_cladelab(node=MRCA(tr.lifedata, 'Lepilemur_leucopus', 'Homo_sapiens'), label = 'Primata') + 
  geom_highlight(node=MRCA(tr.lifedata, 'Procavia_capensis', 'Loxodonta_africana'), fill='beige') +
  ggtree::geom_cladelab(node=MRCA(tr.lifedata, 'Procavia_capensis', 'Loxodonta_africana'), label = 'Paenungulata') + 
  theme(
    legend.position = 'bottom',
    legend.direction = 'horizontal'
  ) + 
  scale_color_distiller(
    palette = "Reds", direction = 1,
    guide = guide_colorbar(
      title="Lifespan (log(y))",
      title.theme =  element_text(size = 6, face = "bold", colour = "black"),
      title.position = "top",
      title.hjust = 0.5
    )
  ) #+ 
  # xlim(c(NA,400))
p.tree.life.circ
```

```{r Body size evolution - Bats}
tr.sizedata.chiroptera <- tr.sizedata %>% 
  tidytree::tree_subset(MRCA(tr.sizedata, 'Myotis_lucifugus', 'Pteropus_vampyrus'), levels_back = 0)

myotis.nodelab <- tr.sizedata.chiroptera@phylo %>% keep.tip(tr.sizedata.chiroptera@phylo$tip.label[str_detect(tr.sizedata.chiroptera@phylo$tip.label, 'Myotis')]) %>% as_tibble() %>% filter(node==parent) %>% pull(label)
myotis.node <- tr.sizedata.chiroptera %>% as_tibble %>% filter(label==myotis.nodelab) %>% pull(node)

p.tree.size.bats <- tr.sizedata.chiroptera %>% 
  ggtree(
    aes(color=as.numeric(lnSize.median),
        text=label)
  ) + 
  geom_highlight(node=myotis.node, fill='gold') + 
  geom_cladelab(node=myotis.node, label = 'Myotis', align=T) + 
  geom_highlight(node=MRCA(tr.sizedata.chiroptera, 'Eptesicus_nilssonii', 'Eptesicus_fuscus'), fill='blue') + 
  geom_cladelab(node=MRCA(tr.sizedata.chiroptera, 'Eptesicus_nilssonii', 'Eptesicus_fuscus'), label = 'Eptesicus', align=T) + 
  geom_highlight(node=MRCA(tr.sizedata.chiroptera, 'Rousettus_aegyptiacus', 'Pteropus_vampyrus'), fill='pink') + 
  geom_cladelab(node=MRCA(tr.sizedata.chiroptera, 'Rousettus_aegyptiacus', 'Pteropus_vampyrus'), label = 'Pteropodidae', align=T) + 
  geom_highlight(node=MRCA(tr.sizedata.chiroptera, 'Artibeus_jamaicensis', 'Macrotus_californicus'), fill='lightblue') + 
  geom_cladelab(node=MRCA(tr.sizedata.chiroptera, 'Artibeus_jamaicensis', 'Macrotus_californicus'), label = 'Phyllostomidae', align=T) + 
  # geom_highlight(node=nodeid(tr.sizedata.chiroptera, 'Noctilio_leporinus'), fill='lightblue') + 
  geom_cladelab(node=nodeid(tr.sizedata.chiroptera, 'Noctilio_leporinus'), label = 'Noctilionidae', align=T) + 
  # geom_tiplab(aes(subset=(node==nodeid(tr.sizedata.chiroptera, 'Mystacina_tuberculata')), label = 'Mystacinidae'), color='black', align=T) + 
  geom_cladelab(node=nodeid(tr.sizedata.chiroptera, 'Mystacina_tuberculata'), label = 'Mystacinidae', align=T) + 
  geom_highlight(node=MRCA(tr.sizedata.chiroptera, 'Rhinolophus_euryale', 'Megaderma_lyra'), fill='lightgreen') + 
  geom_cladelab(node=MRCA(tr.sizedata.chiroptera, 'Rhinolophus_euryale', 'Megaderma_lyra'), label = 'Rhinolophoidea', align=T) + 
  geom_highlight(node=MRCA(tr.sizedata.chiroptera, 'Molossus_molossus', 'Chaerephon_pumilus'), fill='coral') + 
  geom_cladelab(node=MRCA(tr.sizedata.chiroptera, 'Molossus_molossus', 'Chaerephon_pumilus'), label = 'Molossidae', align=T) + 
  # scale_color_distiller(
  #     palette = "Blues", direction = 1,
  #     guide = guide_colorbar(
  #       title="Body Size (log(g))",
  #       title.theme =  element_text(size = 6, face = "bold", colour = "black"),
  #       title.position = "top",
  #       title.hjust = 0.5
  #     )
  #   ) + 
  guides(color=guide_colorbar('Body size (log)')) + 
  theme(
    legend.position = c(0.1,0.8)
  ) +
  xlim(c(NA,70))
p.tree.size.bats
```

```{r Lifespan evolution - Bats}
### Lifespan ###

tr.lifedata.chiroptera <- tr.lifedata %>% 
  tidytree::tree_subset(MRCA(tr.lifedata, 'Myotis_lucifugus', 'Pteropus_vampyrus'), levels_back = 0)

p.tree.life.bats <- tr.lifedata.chiroptera %>% 
  ggtree(
    aes(color=as.numeric(lnLife.median))
  ) + 
  geom_highlight(node=myotis.node, fill='gold') +
  geom_cladelab(node=myotis.node, label = 'Myotis', align=T) +
  geom_highlight(node=MRCA(tr.lifedata.chiroptera, 'Eptesicus_nilssonii', 'Eptesicus_fuscus'), fill='blue') +
  geom_cladelab(node=MRCA(tr.lifedata.chiroptera, 'Eptesicus_nilssonii', 'Eptesicus_fuscus'), label = 'Eptesicus', align=T) +
  geom_highlight(node=MRCA(tr.lifedata.chiroptera, 'Rousettus_aegyptiacus', 'Pteropus_vampyrus'), fill='pink') +
  geom_cladelab(node=MRCA(tr.lifedata.chiroptera, 'Rousettus_aegyptiacus', 'Pteropus_vampyrus'), label = 'Pteropodidae', align=T) +
  geom_highlight(node=MRCA(tr.lifedata.chiroptera, 'Artibeus_jamaicensis', 'Macrotus_californicus'), fill='lightblue') +
  geom_cladelab(node=MRCA(tr.lifedata.chiroptera, 'Artibeus_jamaicensis', 'Macrotus_californicus'), label = 'Phyllostomidae', align=T) +
  geom_cladelab(node=nodeid(tr.lifedata.chiroptera, 'Noctilio_leporinus'), label = 'Noctilionidae', align=T) +
  geom_cladelab(node=nodeid(tr.lifedata.chiroptera, 'Mystacina_tuberculata'), label = 'Mystacinidae', align=T) +
  geom_highlight(node=MRCA(tr.lifedata.chiroptera, 'Rhinolophus_euryale', 'Megaderma_lyra'), fill='lightgreen') +
  geom_cladelab(node=MRCA(tr.lifedata.chiroptera, 'Rhinolophus_euryale', 'Megaderma_lyra'), label = 'Rhinolophoidea', align=T) +
  geom_highlight(node=MRCA(tr.lifedata.chiroptera, 'Molossus_molossus', 'Chaerephon_pumilus'), fill='coral') +
  geom_tiplab(
    aes(
      subset = label %in% c(our_genomes, "Myotis_grisescens", "Rhinolophus_rouxii", "Myotis_brandtii", "Nycticeius_humeralis", "Natalus_stramineus", "Desmodus_rotundus", "Pteropus_giganteus", "Eonycteris_spelaea"),
      label = label %>% str_replace_all("_", " ")
    ),
    fontface='italic',
    size=2,
    color='black'
  ) +
  scale_color_distiller(palette = "Blues",
                        direction = 1,
                        guide = guide_colorbar(
                          title="Body size (log)",
                          title.theme =  element_text(size = 6, face = "bold", colour = "black"),
                          title.position = "top",
                          title.hjust = 0.5
                          )
                        ) +
  guides(color=guide_colorbar('Lifespan (log)')) +
  theme(
    legend.position = 'bottom',
    legend.direction = 'horizontal'
  ) +
  xlim(c(NA,450))
p.tree.life.bats #%>% plotly::ggplotly()
```

```{r LQ evolution - Bats}
### Lifespan ###

tr.sizelife.lq.chiroptera <- tr.sizelife.lq %>% 
  tidytree::tree_subset(MRCA(tr.sizelife.lq, 'Myotis_lucifugus', 'Pteropus_vampyrus'), levels_back = 0)

p.tree.LQ.bats <- tr.sizelife.lq.chiroptera %>% 
  ggtree(
    aes(
      color=as.numeric(LQ.median),
      # text=label
    ),
    branch.length = "LQ.branch.length"
  ) + 
  geom_highlight(node=myotis.node, fill='gold') +
  geom_cladelab(node=myotis.node, label = 'Myotis', align=T) +
  geom_highlight(node=MRCA(tr.sizelife.lq.chiroptera, 'Eptesicus_nilssonii', 'Eptesicus_fuscus'), fill='blue') +
  geom_cladelab(node=MRCA(tr.sizelife.lq.chiroptera, 'Eptesicus_nilssonii', 'Eptesicus_fuscus'), label = 'Eptesicus', align=T) +
  geom_highlight(node=MRCA(tr.sizelife.lq.chiroptera, 'Rousettus_aegyptiacus', 'Pteropus_vampyrus'), fill='pink') +
  geom_cladelab(node=MRCA(tr.sizelife.lq.chiroptera, 'Rousettus_aegyptiacus', 'Pteropus_vampyrus'), label = 'Pteropodidae', align=T) +
  geom_highlight(node=MRCA(tr.sizelife.lq.chiroptera, 'Artibeus_jamaicensis', 'Macrotus_californicus'), fill='lightblue') +
  geom_cladelab(node=MRCA(tr.sizelife.lq.chiroptera, 'Artibeus_jamaicensis', 'Macrotus_californicus'), label = 'Phyllostomidae', align=T) +
  # geom_highlight(node=nodeid(tr.sizelife.lq.chiroptera, 'Noctilio_leporinus'), fill='lightblue') +
  geom_cladelab(node=nodeid(tr.sizelife.lq.chiroptera, 'Noctilio_leporinus'), label = 'Noctilionidae', align=T) +
  # geom_tiplab(aes(subset=(node==nodeid(tr.sizelife.lq.chiroptera, 'Mystacina_tuberculata')), label = 'Mystacinidae'), color='black', align=T) +
  geom_cladelab(node=nodeid(tr.sizelife.lq.chiroptera, 'Mystacina_tuberculata'), label = 'Mystacinidae', align=T) +
  geom_highlight(node=MRCA(tr.sizelife.lq.chiroptera, 'Rhinolophus_euryale', 'Megaderma_lyra'), fill='lightgreen') +
  geom_cladelab(node=MRCA(tr.sizelife.lq.chiroptera, 'Rhinolophus_euryale', 'Megaderma_lyra'), label = 'Rhinolophoidea', align=T) +
  geom_highlight(node=MRCA(tr.sizelife.lq.chiroptera, 'Molossus_molossus', 'Chaerephon_pumilus'), fill='coral') +
  geom_tiplab(
    aes(
      subset = label %in% c(our_genomes, "Myotis_grisescens", "Rhinolophus_rouxii", "Myotis_brandtii", "Nycticeius_humeralis", "Natalus_stramineus", "Desmodus_rotundus", "Pteropus_giganteus", "Eonycteris_spelaea"),
      label = label %>% str_replace_all("_", " ")
    ),
    fontface='italic',
    size=2,
    color='black'
  ) +
  scale_color_distiller(palette = "Blues",
                        direction = 1,
                        guide = guide_colorbar(
                          title="Body size (log)",
                          title.theme =  element_text(size = 6, face = "bold", colour = "black"),
                          title.position = "top",
                          title.hjust = 0.5
                          )
                        ) +
  guides(color=guide_colorbar('LQ')) + 
  theme(
    legend.position = 'bottom',
    legend.direction = 'horizontal'
  ) #+ 
  # xlim(c(NA,450))
p.tree.LQ.bats #%>% plotly::ggplotly()
```

```{r DoubleTree Mammals Size Lifespan}
### Double Tree ###
p.tree.life.base <- tr.lifedata %>% 
  ggtree() + 
  scale_x_sqrt()
p.tree.size.base <- tr.sizedata %>% 
  ggtree() + 
  scale_x_sqrt()

d.dbltree.mam.size <- p.tree.size.base$data
d.dbltree.mam.life <- p.tree.life.base$data

d.dbltree.mam.size$x <- d.dbltree.mam.size$x %>% divide_by(5)

# d.dbltree.mam.life$x <- d.dbltree.mam.life$x %>% divide_by(5)

d.dbltree.mam.life$x <- max(d.dbltree.mam.life$x) - d.dbltree.mam.life$x + max(d.dbltree.mam.size$x) + 10

p.dbltree.sizelife <-
  ggplot() +
  geom_tree(data=d.dbltree.mam.size, aes(color=lnSize.median), size=1) +
  # tr.sizedata %>% 
  # ggtree(data=d.dbltree.mam.size, aes(color=lnSize.median), size=1) +
  # # scale_color_distiller("Body size (log)", palette = "Blues", direction = 1) +
  scale_color_distiller(
    limits=c(tr.sizedata@extraInfo$lnSize.median %>% min, tr.sizedata@extraInfo$lnSize.median %>% max),
    palette = "Blues", 
    direction = 1,
    guide = guide_colorbar(
      title="Body size (log)",
      title.theme =  element_text(size = 6, face = "bold", colour = "black"),
      title.position = "left",
      title.hjust = 0.5, 
      title.vjust = 0.75,
      order = 1
    )
  )+ 
  geom_nodepoint(data = d.dbltree.mam.size, aes(color=lnSize.median, x=x, y=y), inherit.aes = F, size=2) + 
  geom_tippoint(data = d.dbltree.mam.size, aes(color=lnSize.median, x=x, y=y), inherit.aes = F, size=2) +
  new_scale_color() + 
  geom_tree(
    data=d.dbltree.mam.life, 
    aes(color=lnLife.median), 
    inherit.aes = F, size=1
  ) + 
  geom_nodepoint(data=d.dbltree.mam.life, aes(color=lnLife.median, x=x, y=y), inherit.aes = F, size=2) + 
  geom_tippoint(data=d.dbltree.mam.life, aes(color=lnLife.median, x=x, y=y), inherit.aes = F, size=2) +
  scale_color_distiller(
    limits=c(tr.lifedata@extraInfo$lnLife.median %>% min, tr.lifedata@extraInfo$lnLife.median %>% max),
    palette = "Reds",
    direction = 1,
    guide = guide_colorbar(
      title="Lifespan (log)",
      title.theme =  element_text(size = 6, face = "bold", colour = "black"),
      title.position = "left",
      title.hjust = 0.5,
      title.vjust = 0.75,
      order = 3
    )
  )  + 
  theme_tree() +
  theme(
    plot.background = element_rect(fill="grey", color="grey"),
    panel.background = element_rect(fill="grey", color="grey"),
  legend.text = element_text(
    size = 6, 
    face = "plain", colour = "black"
  ),
    legend.background = element_blank(),
  legend.position = "bottom",
  legend.box = "horizontal",
  legend.direction = "horizontal",
  legend.box.just = "right",
  legend.spacing.y = unit(0.5,"mm")
  # legend.direction = "vertical"
  )

p.dbltree.sizelife
```


```{r DoubleTree size + lifespan}
### Double Tree ###
p.tree.life.bats.base <- tr.lifedata.chiroptera %>% 
  ggtree() + 
  scale_x_sqrt()
p.tree.size.bats.base <- tr.sizedata.chiroptera %>% 
  ggtree() + 
  scale_x_sqrt()

d.dbltree.3 <- p.tree.size.bats.base$data
d.dbltree.4 <- p.tree.life.bats.base$data

d.dbltree.4$x <- max(d.dbltree.4$x) - d.dbltree.4$x + max(d.dbltree.3$x) + 10

p.dbltree.bats.sizelife <-
  tr.sizedata.chiroptera %>% 
  ggtree(data=d.dbltree.3, aes(color=lnSize.median), size=1) +
  # scale_color_distiller("Body size (log)", palette = "Blues", direction = 1) +
  scale_color_distiller(
    limits=c(tr.sizedata.chiroptera@extraInfo$lnSize.median %>% min, tr.sizedata.chiroptera@extraInfo$lnSize.median %>% max),
    palette = "Blues", 
    direction = 1,
    guide = guide_colorbar(
      title="Body size (log)",
      title.theme =  element_text(size = 6, face = "bold", colour = "black"),
      title.position = "left",
      title.hjust = 0.5, 
      title.vjust = 0.75,
      order = 1
    )
    # guide=guide_none()
  ) +
  # scale_fill_distiller(
  #   limits=c(tr.lifedata.chiroptera@extraInfo$lnLife.median %>% min, tr.lifedata.chiroptera@extraInfo$lnLife.median %>% max), 
  #   palette = "Reds", 
  #   direction = 1,
  #   guide = guide_colorbar(
  #     title="Lifespan",
  #     title.theme =  element_text(size = 6, face = "bold", colour = "black"),
  #     title.position = "left",
  #     title.hjust = 0.5, 
  #     title.vjust = 0.75,
  #     order = 3
  #   )
  #   # guide=guide_none()
  # ) +
  geom_nodepoint(size=2) + 
  geom_tippoint(size=2) +
  # geom_tiplab(aes(label = if_else(is.na(Genome), "", label)), 
  #             x=(min(d.dbltree.4$x)+max(d.dbltree.3$x))/2, color="black", hjust = 0.5) +
  # geom_text_repel(
  #   aes(
  #     label = if_else(
  #       label %in% c(our_genomes, "Myotis_grisescens", "Rhinolophus_rouxii", "Myotis_brandtii", "Nycticeius_humeralis", "Natalus_stramineus", "Desmodus_rotundus", "Pteropus_giganteus", "Eonycteris_spelaea"), 
  #       label, 
  #       NA
  #     ) %>% str_replace_all("_", " ")
  #   ), 
  #   direction = "y", 
  #   force = 0.5, 
  #   segment.size = NA,
  #   size=2.5,
  #   x=(min(d.dbltree.4$x)+max(d.dbltree.3$x))/2, 
  #   color="black", 
  #   hjust = 0.5
  # ) +
  new_scale_color() + 
  geom_tree(
    data=d.dbltree.4, 
    aes(color=lnLife.median), 
    inherit.aes = F, size=1
  ) + 
  geom_nodepoint(data=d.dbltree.4, aes(color=lnLife.median, x=x, y=y), inherit.aes = F, size=2) + 
  geom_tippoint(data=d.dbltree.4, aes(color=lnLife.median, x=x, y=y), inherit.aes = F, size=2) +
  # scale_color_viridis_c(option = "D") + 
  # scale_color_distiller(
  #   palette = "Reds", direction = 1,
  #   guide = guide_colorbar(
  #     title="Cancer Risk (log2)",
  #     title.theme =  element_text(size = 6, face = "bold", colour = "black"),
  #     title.position = "top",
  #     title.hjust = 0.5
  #   )
  # ) + 
  scale_color_distiller(
    limits=c(tr.lifedata.chiroptera@extraInfo$lnLife.median %>% min, tr.lifedata.chiroptera@extraInfo$lnLife.median %>% max),
    palette = "Reds",
    direction = 1,
    guide = guide_colorbar(
      title="Lifespan (log)",
      title.theme =  element_text(size = 6, face = "bold", colour = "black"),
      title.position = "left",
      title.hjust = 0.5,
      title.vjust = 0.75,
      order = 3
    )
    # guide=guide_none()
  ) +
  theme(
    plot.background = element_rect(fill="grey", color="grey"),
    panel.background = element_rect(fill="grey", color="grey"),
  legend.text = element_text(
    size = 6, 
    face = "plain", colour = "black"
  ),
    legend.background = element_blank(),
  legend.position = c(0.5, 0.15),#"bottom",
  legend.box = "vertical",
  legend.direction = "horizontal",
  legend.box.just = "right",
  legend.spacing.y = unit(0.5,"mm")
  # legend.direction = "vertical"
  )

p.dbltree.bats.sizelife
```

```{r DoubleTree lifespan + LQ}
### Double Tree ###
p.tree.life.bats.base <- tr.lifedata.chiroptera %>%
  ggtree()
p.tree.LQ.bats.base <- tr.sizelife.lq.chiroptera %>% 
  ggtree(branch.length = "LQ.branch.length")

d.dbltree.3 <- p.tree.life.bats.base$data
d.dbltree.4 <- p.tree.LQ.bats.base$data

d.dbltree.4$x <- max(d.dbltree.4$x) - d.dbltree.4$x + max(d.dbltree.3$x) + 50

p.dbltree.all <-
  tr.lifedata.chiroptera %>% 
  ggtree(data=d.dbltree.3, aes(color=lnLife.median), size=1) +
  # scale_color_distiller("Body size (log)", palette = "Blues", direction = 1) +
  scale_color_distiller(
    limits=c(tr.lifedata.chiroptera@extraInfo$lnLife.median %>% min, tr.lifedata.chiroptera@extraInfo$lnLife.median %>% max),
    palette = "Blues", 
    direction = 1,
    guide = guide_colorbar(
      title="Lifespan (log)",
      title.theme =  element_text(size = 6, face = "bold", colour = "black"),
      title.position = "left",
      title.hjust = 0.5, 
      title.vjust = 0.75,
      order = 1
    )
    # guide=guide_none()
  ) +
  # scale_fill_distiller(
  #   limits=c(tr.lifedata.chiroptera@extraInfo$lnLife.median %>% min, tr.lifedata.chiroptera@extraInfo$lnLife.median %>% max), 
  #   palette = "Reds", 
  #   direction = 1,
  #   guide = guide_colorbar(
  #     title="Lifespan",
  #     title.theme =  element_text(size = 6, face = "bold", colour = "black"),
  #     title.position = "left",
  #     title.hjust = 0.5, 
  #     title.vjust = 0.75,
  #     order = 3
  #   )
  #   # guide=guide_none()
  # ) +
  geom_nodepoint(size=2) + 
  geom_tippoint(size=2) +
  # geom_tiplab(aes(subset = label %in% c(our_genomes, "Myotis_grisescens", "Rhinolophus_rouxii", "Myotis_brandtii", "Nycticeius_humeralis", "Natalus_stramineus", "Desmodus_rotundus", "Pteropus_giganteus", "Eonycteris_spelaea")),
  #             x=(min(d.dbltree.4$x)+max(d.dbltree.3$x))/2, color="black", hjust = -1) +
  geom_segment(
    data = d.dbltree.3 %>% 
      filter(label %in% c("Myotis_lucifugus", "Myotis_auriculus", "Myotis_grisescens", "Rhinolophus_rouxii", "Myotis_brandtii", "Nycticeius_humeralis", "Natalus_stramineus", "Desmodus_rotundus", "Pteropus_giganteus", "Eonycteris_spelaea")) %>% 
      left_join(
        d.dbltree.4 %>% select(label, xend=x), 
        by='label'
      ), 
    aes(
      x=x, 
      xend=xend,
      yend=y
    ),
    color='black',
    lty='dotted'
  ) + 
  geom_label(
    aes(
      label = if_else(
        label %in% c("Myotis_lucifugus", "Myotis_auriculus", "Myotis_grisescens", "Rhinolophus_rouxii", "Myotis_brandtii", "Nycticeius_humeralis", "Natalus_stramineus", "Desmodus_rotundus", "Pteropus_giganteus", "Eonycteris_spelaea"),
        label,
        NA
      ) %>% str_replace_all("_", " ")
    ),
    direction = "y",
    force = 0.5,
    segment.size = NA,
    size=2.5,
    x=(min(d.dbltree.4$x)+max(d.dbltree.3$x))/2,
    color="black",
    fill='grey',
    hjust = 0.5
  ) +
  new_scale_color() + 
  geom_tree(
    data=d.dbltree.4, 
    aes(color=LQ.median), 
    inherit.aes = F, size=1
  ) + 
  geom_nodepoint(data=d.dbltree.4, aes(color=LQ.median, x=x, y=y), inherit.aes = F, size=2) + 
  geom_tippoint(data=d.dbltree.4, aes(color=LQ.median, x=x, y=y), inherit.aes = F, size=2) +
  scale_color_distiller(
    limits=c(tr.sizelife.lq.chiroptera@extraInfo$LQ.median %>% min, tr.sizelife.lq.chiroptera@extraInfo$LQ.median %>% max),
    palette = "Reds",
    direction = 1,
    guide = guide_colorbar(
      title="LQ",
      title.theme =  element_text(size = 6, face = "bold", colour = "black"),
      title.position = "left",
      title.hjust = 0.5,
      title.vjust = 0.75,
      order = 3
    )
    # guide=guide_none()
  ) +
  theme(
    plot.background = element_rect(fill="grey", color="grey"),
    panel.background = element_rect(fill="grey", color="grey"),
  legend.text = element_text(
    size = 6, 
    face = "plain", colour = "black"
  ),
    legend.background = element_blank(),
  legend.position = "bottom", #c(0.5, 0.15),
  legend.box = "vertical",
  legend.direction = "horizontal",
  legend.box.just = "right",
  legend.spacing.y = unit(0.5,"mm")
  # legend.direction = "vertical"
  )

p.dbltree.all
```


### All together figure - Myotis

```{r}
p.tr.myotis <- tr.upham %>%
  keep.tip(tr.lifedata.chiroptera@phylo$tip.label) %>% 
  tidytree::tree_subset(MRCA(tr.upham %>%
  keep.tip(tr.lifedata.chiroptera@phylo$tip.label), 'Myotis_lucifugus', 'Nycticeius_humeralis'), levels_back = 0) %>% 
  ggtree(
    size=1
  ) + 
  geom_tiplab(
    size=3
  ) + 
  geom_nodelab(
    aes(label=label)
  ) + 
  xlim(c(NA, 50))


fig.myotis.sizelifelq <- (
  (
    p.tr.myotis
  ) | 
  (
    (p.bodysize.myotis + theme(legend.position = 'left', legend.direction = 'vertical', legend.title.align = 0)) / 
    (p.lifespan.myotis + theme(legend.position = 'left', legend.direction = 'vertical', legend.title.align = 0)) / 
    (p.LQ.myotis + theme(legend.position = 'left', legend.direction = 'vertical', legend.title.align = 0))
  ) 
) +
    # guide_area()  + 
  plot_layout(width=c(2,1))+
  plot_annotation(tag_levels = 'A') & 
  # theme_pubr() &
  theme(legend.box='vertical',
        legend.direction = 'vertical',
        legend.key.height = unit(0.3, 'in'),
        legend.key.width = unit(0.25, 'in'),
        legend.key.size = unit(0.25, 'in'),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.tag = element_text(size = 8, face = 'bold'))

fig.myotis.sizelifelq

ggsave(
  '../output/draft_figs/Myotis_size_life_LQ_upham.pdf', 
  plot=fig.myotis.sizelifelq,
  width = 5,
  height = 6,
  units = 'in',
  dpi=300
)

```


## Cancer Succeptibility & RICR

The consequences of changes in body size and lifespan include changes in the 
number of cells in an organism's body and the time they have for any given cell
to become a tumor. Peto's Paradox implies that cancer risk per cell must decrease
as the body size and lifespan of a species increases. 

The cancer risk $K$ of an individual can be summarized as:

$ K \approx {t^6}{D} $

where  $t$ is lifespan and $D$ is body size. Given that we have predictions of body size and lifespan at every node in the tree, we can estimate $K$ for every node. Vazquez & Lynch (2020) defined the relative cancer risk for a node of interest as $\log_2(\frac{K_{anc}}{K_{node}})$, where $K_{anc}$ is the cancer risk $K$ of the ancestral node, and $K_{node}$ is the cancer risk $K$ of the node of interest. In this schema, positive RICR scores means that the cancer risk of the ancestor is higher than that of the node of interest, and vice versa. If the RICR score is negative, it indicates that the node of interest has an increased risk of cancer than its ancestor. _These nodes with Reduced Intrinsic Cancer Risk (RICR) are the nodes where we expect an enhancement of tumor suppression._

<!-- We saw in Vazquez & Lynch (2020) and Vazquez _et al._ (2022) that there is evidence for conservation of genes associated with increase tumor suppression at nodes with positive RICR scores -->

```{r RICR Calculations}
# Recalculate log2CancerSucceptabilityChange with real lifespans
cancerSucceptibility.table <- tr.sizelife.lq %>%
  as_tibble %>% 
  ### Cancer Susceptibility
  mutate(
    K1 = exp(lnLife.median)^6 * exp(lnSize.median),
    lnK1 = 6*lnLife.median + lnSize.median
  )

cancerSucceptibility.table <- cancerSucceptibility.table %>% 
  mutate(
    Ancestor = label %>%
      sapply(
        .,
        function(n, d=cancerSucceptibility.table){
          if(is.na(n)){return(NA)}
          #print(n)
          #print(length(n))
          p.node <- d %>% filter(label==n) %>% pull(parent) %>% unique
          d %>% filter(node == p.node) %>% pull(label) %>% unique %>% return
        }
      ) %>% str_replace_all("\\.", " ") %>%
      str_replace("Root", "chiroptera"),
    K2 = parent %>%
      sapply(
        .,
        function(n, d=cancerSucceptibility.table){
          d %>% filter(node==n) %>% pull(K1) %>% unique
        }
      ),
    lnK2 = parent %>%
      sapply(
        .,
        function(n, d=cancerSucceptibility.table){
          d %>% filter(node==n) %>% pull(lnK1) %>% unique
        }
      ),
    CancerSucceptabilityChange = K2/K1,
    log2CancerSucceptabilityChange = log2(K2)-log2(K1),
    label = label %>% str_replace_all("\\.", " ")
  )

tr.cancerSucceptibility <- cancerSucceptibility.table %>% 
  as.treedata()

cancerSucceptibility.table %>% 
  filter(str_detect(label, "Myotis")) %>% 
  select(parent,node,label, lnSize.median, lnLife.median, K1, K2, log2CancerSucceptabilityChange) %>% 
  arrange(log2CancerSucceptabilityChange)

cancerSucceptibility.table %>% 
  filter(label %in% tr.sizelife.lq.chiroptera@phylo$tip.label) %>% 
  select(parent,node,label, lnSize.median, lnLife.median, K1, K2, log2CancerSucceptabilityChange) %>% 
  arrange(log2CancerSucceptabilityChange)
```


```{r Plot RICR (time-scaled) - Mammals}
p.cancerSucceptibility <- tr.cancerSucceptibility %>% 
  ggtree(
    aes(color=log2CancerSucceptabilityChange),
    layout = 'fan',
    open.angle = 180
  ) + 
  geom_tippoint(
    aes(
      fill=lnK1
    ),
    shape=21,
    color='black'
  ) + 
  geom_nodepoint(
    aes(
      fill=lnK1
    ),
    shape=21,
    color='black'
  ) + 
  scale_color_viridis_c(
    "RICR (log2)",
    option = 'C'
  ) + 
  scale_fill_viridis_c(
    "Cancer Risk (log)",
    option = 'D'
  ) + 
  theme(
    legend.position = c(0.5, 0.4),
    legend.direction = 'horizontal',
    legend.box = 'horizontal'
  )

p.cancerSucceptibility

```

```{r Plot RICR (time-scaled) - Bats}

tr.RICR.chiroptera <- tr.cancerSucceptibility %>% 
  tidytree::tree_subset(MRCA(tr.cancerSucceptibility, 'Myotis_lucifugus', 'Pteropus_vampyrus'), levels_back = 0)

p.RICR.bats <- tr.RICR.chiroptera %>% 
  ggtree(
    aes(color=log2CancerSucceptabilityChange),
    layout = 'fan',
    open.angle = 180,
    size=1.5
  ) + 
  geom_tippoint(
    aes(
      fill=lnK1
    ),
    shape=21,
    color='black'
  ) + 
  geom_nodepoint(
    aes(
      fill=lnK1
    ),
    shape=22,
    color='black'
  ) + 
  scale_color_viridis_c(
    "RICR (log2)",
    option = 'C'
  ) + 
  scale_fill_viridis_c(
    "Cancer Risk (log)",
    option = 'D'
  ) + 
  geom_tiplab2(
    aes(
      subset = label %in% c(our_genomes, "Myotis_grisescens", "Rhinolophus_rouxii", "Myotis_brandtii", "Nycticeius_humeralis", "Natalus_stramineus", "Desmodus_rotundus", "Pteropus_giganteus", "Eonycteris_spelaea"),
      label = label %>% str_replace_all("_", " ")
    ),
    fontface='italic', offset=1,
    size=2,
    color='black'
  ) +
  theme(
    legend.position = c(0.5, 0.4),
    legend.direction = 'horizontal',
    legend.box = 'horizontal'
  )

p.RICR.bats
```

It seems like overall, there's not much change in cancer risk at nodes within the tree - all the changes happen at the tips. Within the root of _Myotis_, the RICR changes are small (<1). In both megabats and microbats, changes in RICR within the tree are relatively small but dynamic - this is probably due to the density of species in such a short period of time compared to what I'm used to in elephants and other large-bodied mammals. 

At the common ancestor of Grey myotis and the other bats, there's a series of small increases in RICR (3.8, 0.99, 4.24, 0.65) from the common ancestor until you get to _grisescens_ -  then there's a big drop (-12.7) in RICR. Brandt's bat is the longest-lived bat and the daughter of a short-lived node, so it makes sense that there's a big drop there (-0.22 to -6.8). All of our _Myotis_ show drops in RICR, especially for _lucifugus_ (-4.1). Note that for _Myotis myotis_, while it has a low drop in RICR (-1.0), its most recent ancestor had a larger drop (-3.2). The second greatest drop in RICR in in Megabats, in _Pteropus gigantus_ (-7.3).  

### RICR-based version of bat fig

```{r RangePlot RICR - Myotis}
p.RICR.myotis <- tr.cancerSucceptibility %>%
  tidytree::tree_subset(MRCA(tr.cancerSucceptibility, 'Myotis_lucifugus', 'Nycticeius_humeralis'), levels_back = 0) %>%
  as_tibble %>% 
  arrange(log2CancerSucceptabilityChange) %>% 
  mutate(label = factor(label, levels=label)) %>% 
  ggplot(
    aes(
      y=label,
      x=log2CancerSucceptabilityChange
      )
  ) +
  geom_segment(
    aes(y=label, yend=label,
        x=0, xend=log2CancerSucceptabilityChange,
        color=log2CancerSucceptabilityChange)
  ) + 
  geom_point(aes(color=log2CancerSucceptabilityChange), size=1) +
  # geom_point(aes(x=LQ.low, color=LQ.low), size=1.5, stroke=2, pch="]") +
  # geom_point(aes(x=LQ.high, color=LQ.high), size=1.5, stroke=2, pch="[") +
  scale_color_viridis_c(
    option = 'D',
    guide = guide_colorbar(
      title="RICR",
      title.theme =  element_text(size = 6, face = "bold", colour = "black"),
      title.position = "top",
      title.hjust = 0.5
    )
  ) +
  labs(
    x="RICR",
    y="Node"
  ) + 
  theme_pubr()+
  labs_pubr() + 
  theme(
    text = element_text(face = "plain", 
                        colour = "black", lineheight = 0.9, 
                        hjust = 0.5, vjust = 0.5, angle = 0, margin = margin(), 
                        debug = FALSE), 
    axis.text = element_text(size = 6, 
                               colour = "black", face = "bold"),
    axis.title = element_text(size = 8, 
                              colour = "black", face = "bold"),
    plot.title = element_text(size = 8, 
                              colour = "black", lineheight = 1, face = "bold"), 
    legend.text = element_text(size = 6, 
                               face = "plain", colour = "black"),
    legend.position = "bottom"
  )

p.RICR.myotis
```

```{r RangePlot RICR v2 - Myotis}
tbl.RICR.myotis2 <- tr.cancerSucceptibility %>%
  tidytree::tree_subset(MRCA(tr.cancerSucceptibility, 'Myotis_lucifugus', 'Nycticeius_humeralis'), levels_back = 0) %>%
  as_tibble %>% 
  arrange(lnK1) %>% 
  mutate(label = str_replace_all(label, "_", " ")) %>% 
  mutate(label = factor(label, levels=label))

high.K <- tbl.RICR.myotis2$label[str_detect(tbl.RICR.myotis2$label, "Myotis myotis")]
mid.K <- tbl.RICR.myotis2$label[str_detect(
  tbl.RICR.myotis2$label, 
  # "Myotis_septentrionalis"
  "1668"
)]
low.K = tbl.RICR.myotis2$label[str_detect(tbl.RICR.myotis2$label, "Myotis auriculus")]

p.RICR.myotis2 <- tbl.RICR.myotis2 %>% 
  ggplot(
    aes(
      y=label,
      x=lnK1
      )
  ) +
  geom_segment(
    aes(y=label, yend=label,
        x=lnK2, xend=lnK1,
        color=log2CancerSucceptabilityChange),
    arrow = arrow(length = unit(0.1, 'cm'),type='closed')
  ) + 
  geom_point(aes(x=lnK2), size=2, shape="|") +
  geom_segment(
    aes(
      y=high.K,
      yend = mid.K,
      x=-Inf,
      xend=-Inf
    ),
    color='blue',
    size=2
  )+
  geom_segment(
    aes(
      y=mid.K,
      yend = low.K,
      x=-Inf,
      xend=-Inf
    ),
    color='red',
    size=2
  )+
  # geom_point(aes(x=LQ.low, color=LQ.low), size=1.5, stroke=2, pch="]") +
  # geom_point(aes(x=LQ.high, color=LQ.high), size=1.5, stroke=2, pch="[") +
  scale_color_viridis_c(
    option = 'D',
    guide = guide_colorbar(
      title="RICR",
      title.theme =  element_text(size = 6, face = "bold", colour = "black"),
      title.position = "top",
      title.hjust = 0.5
    )
  ) +
  labs(
    x="Cancer Risk",
    y="Node"
  ) + 
  theme_pubr()+
  labs_pubr() + 
  guides(
    shape = guide_legend()
  ) +
  theme(
    text = element_text(face = "plain", 
                        colour = "black", lineheight = 0.9, 
                        hjust = 0.5, vjust = 0.5, angle = 0, margin = margin(), 
                        debug = FALSE), 
    axis.text = element_text(size = 6, 
                               colour = "black", face = "bold"),
    axis.title = element_text(size = 8, 
                              colour = "black", face = "bold"),
    plot.title = element_text(size = 8, 
                              colour = "black", lineheight = 1, face = "bold"), 
    legend.text = element_text(size = 6, 
                               face = "plain", colour = "black"),
    legend.position = "bottom"
  )

p.RICR.myotis2
```

```{r RangePlot RICR v3 - Myotis}
p.RICR.myotis3.plot <- tbl.RICR.myotis2 %>% 
  ggplot(
    aes(
      y=label,
      x=lnK1
      )
  ) +
  geom_segment(
    aes(y=label, yend=label,
        x=lnK2, xend=lnK1,
        color=log2CancerSucceptabilityChange),
    arrow = arrow(length = unit(0.2, 'cm'),type='closed')
  ) + 
  geom_point(aes(x=lnK2), size=2, shape="|") +
  scale_color_viridis_c(
    option = 'D',
    guide = guide_colorbar(
      title="RICR",
      title.theme =  element_text(size = 6, face = "bold", colour = "black"),
      title.position = "top",
      title.hjust = 0.5
    )
  ) +
  scale_x_continuous(limits=c(9.5,30)) +
  labs(
    x="Cancer Risk",
    y="Node"
  ) + 
  theme_pubr()+
  labs_pubr() +
  theme(
    text = element_text(face = "plain",
                        colour = "black", lineheight = 0.9,
                        hjust = 0.5, vjust = 0.5, angle = 0, margin = margin(),
                        debug = FALSE),
    axis.text = element_text(size = 6,
                               colour = "black", face = "bold"),
    axis.title = element_text(size = 8,
                              colour = "black", face = "bold"),
    plot.title = element_text(size = 8,
                              colour = "black", lineheight = 1, face = "bold"),
    axis.text.y = element_blank(), 
    axis.ticks.y = element_blank(),
    axis.title.y = element_blank(),
    legend.text = element_text(size = 6,
                               face = "plain", colour = "black"),
    legend.position = "bottom"
  )

p.RICR.myotis.tiles <- tbl.RICR.myotis2 %>% 
  ggplot(
    aes(
      x=0,
      y=label,
      fill=lnK1
    )
  ) + 
    geom_tile(
    width=0.25,
    height=0.5,
    color='black'
  ) +
    scale_fill_viridis_c(
    option = 'B',
    guide = guide_colorbar(
      title="Cancer Risk (log)",
      title.theme =  element_text(size = 6, face = "bold", colour = "black"),
      title.position = "top",
      title.hjust = 0.5
    )
  ) + 
  theme_void() +
  theme(
    legend.position = 'bottom'
  )

p.RICR.myotis.text <- tbl.RICR.myotis2 %>% 
  ggplot(
    aes(
      x=0,
      y=label,
      label=label
    )
  ) + 
    geom_text(
      hjust=1, 
      size=2.5,
      fontface='bold.italic'
    ) +  
  xlim(c(-0.025,0)) + 
  theme_void() +
  theme(
    legend.position = 'bottom'
  )

p.RICR.myotis3 <- (p.RICR.myotis.text + 
  p.RICR.myotis.tiles + 
  p.RICR.myotis3) + 
  # guide_area() + 
  plot_layout(guides='collect',widths = c(0.3,0.01,1)) & 
  theme(
    legend.position = 'bottom',
    legend.text = element_text(size = 6,
                               face = "plain", colour = "black"),
  )
   
p.RICR.myotis3

ggsave(
  '../output/subfigs/myotis_RICR_v3.pdf',
  p.RICR.myotis3,
  height = 5,
  width = 8,
  units = 'in',
  dpi=300
)
ggsave(
  '../output/subfigs/myotis_RICR_v3.png',
  p.RICR.myotis3,
  height = 5,
  width = 8,
  units = 'in',
  dpi=300
)

```

```{r myotis-only size-life-RICR fig}

p.tr.myotis <- tr.cancerSucceptibility %>%
  keep.tip(tr.lifedata.chiroptera@phylo$tip.label) %>% 
  tidytree::tree_subset(MRCA(tr.upham %>%
  keep.tip(tr.lifedata.chiroptera@phylo$tip.label), 'Myotis_lucifugus', 'Nycticeius_humeralis'), levels_back = 0) %>% 
  ggtree(
    size=1
  ) + 
  geom_tiplab(
    size=3
  ) + 
  geom_nodelab(
    aes(label=label),
    geom = 'shadowtext',
    color='white',
    fill='black',
    hjust=1.5,
    vjust=-0.2,
    size=2.5,
  ) + 
  xlim(c(NA, 50))


fig.myotis.sizelifericr <- (
  (
    p.tr.myotis
  ) | 
  (
    (p.bodysize.myotis + 
       # theme(legend.position = 'left', legend.direction = 'vertical', legend.title.align = 0)
       theme(legend.position = 'none')
     ) / 
    (p.lifespan.myotis + 
       # theme(legend.position = 'left', legend.direction = 'vertical', legend.title.align = 0)
       theme(legend.position = 'none')
     ) / 
    (p.RICR.myotis2 + 
       # theme(legend.position = 'left', legend.direction = 'vertical', legend.title.align = 0)
       theme(legend.position = 'none')
     )
  ) 
) +
    # guide_area()  + 
  plot_layout(width=c(1,2))+
  plot_annotation(tag_levels = 'A') & 
  theme(legend.box='vertical',
        legend.direction = 'vertical',
        legend.key.height = unit(0.3, 'in'),
        legend.key.width = unit(0.25, 'in'),
        legend.key.size = unit(0.25, 'in'),
        # axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.tag = element_text(size = 8, face = 'bold'))

fig.myotis.sizelifericr

ggsave(
  '../output/draft_figs/Myotis_size_life_RICR_upham.pdf', 
  plot=fig.myotis.sizelifericr,
  width = 8,
  height = 6,
  units = 'in',
  dpi=300
)
```

```{r Bat averages}
# tr.RICR.chiroptera %>% ggtree(layout='circular') + geom_tiplab2()

node.myotis = MRCA(tr.RICR.chiroptera, 'Myotis_lucifugus', 'Myotis_emarginatus')
node.vespertilionidae = MRCA(tr.RICR.chiroptera, 'Myotis_lucifugus', 'Lasiurus_cinereus')
node.molossidae = MRCA(tr.RICR.chiroptera, 'Molossus_molossus', 'Chaerephon_pumilus')
node.phyllostomidae = MRCA(tr.RICR.chiroptera, 'Macrotus_waterhousii', 'Artibeus_jamaicensis')
node.yinpterochiroptera = MRCA(tr.RICR.chiroptera, 'Macroderma_gigas', 'Pteropus_giganteus')
node.yangochiroptera = MRCA(tr.RICR.chiroptera, 'Myotis_lucifugus', 'Mystacina_tuberculata') 

tr.RICR.myotis <- tr.RICR.chiroptera %>%
  tidytree::tree_subset(node.myotis, levels_back = 0) %>%
  as_tibble %>% 
  summarize(
    label='Myotis',
    lnSize.median = mean(lnSize.median),
    lnLife.median = mean(lnLife.median),
    lnSize.low = mean(lnSize.low),
    lnLife.low = mean(lnLife.low),
    lnSize.high = mean(lnSize.high),
    lnLife.high = mean(lnLife.high),
    lnK1 = mean(lnK1),
    lnK2 = mean(lnK2),
    log2CancerSucceptabilityChange = mean(log2CancerSucceptabilityChange)
  )
tr.RICR.vespertilionidae <- tr.RICR.chiroptera %>%
  tidytree::tree_subset(node.vespertilionidae, levels_back = 0) %>%
  as_tibble %>% 
  summarize(
    label='Vespertilionidae',
    lnSize.median = mean(lnSize.median),
    lnLife.median = mean(lnLife.median),
    lnSize.low = mean(lnSize.low),
    lnLife.low = mean(lnLife.low),
    lnSize.high = mean(lnSize.high),
    lnLife.high = mean(lnLife.high),
    lnK1 = mean(lnK1),
    lnK2 = mean(lnK2),
    log2CancerSucceptabilityChange = mean(log2CancerSucceptabilityChange)
  )
tr.RICR.molossidae <- tr.RICR.chiroptera %>%
  tidytree::tree_subset(node.molossidae, levels_back = 0) %>%
  as_tibble %>% 
  summarize(
    label='Molossidae',
    lnSize.median = mean(lnSize.median),
    lnLife.median = mean(lnLife.median),
    lnSize.low = mean(lnSize.low),
    lnLife.low = mean(lnLife.low),
    lnSize.high = mean(lnSize.high),
    lnLife.high = mean(lnLife.high),
    lnK1 = mean(lnK1),
    lnK2 = mean(lnK2),
    log2CancerSucceptabilityChange = mean(log2CancerSucceptabilityChange)
  )
tr.RICR.phyllostomidae <- tr.RICR.chiroptera %>%
  tidytree::tree_subset(node.phyllostomidae, levels_back = 0) %>%
  as_tibble %>% 
  summarize(
    label='Phyllostomidae',
    lnSize.median = mean(lnSize.median),
    lnLife.median = mean(lnLife.median),
    lnSize.low = mean(lnSize.low),
    lnLife.low = mean(lnLife.low),
    lnSize.high = mean(lnSize.high),
    lnLife.high = mean(lnLife.high),
    lnK1 = mean(lnK1),
    lnK2 = mean(lnK2),
    log2CancerSucceptabilityChange = mean(log2CancerSucceptabilityChange)
  )
tr.RICR.yinpterochiroptera <- tr.RICR.chiroptera %>%
  tidytree::tree_subset(node.yinpterochiroptera, levels_back = 0) %>%
  as_tibble %>% 
  summarize(
    label='Yinpterochiroptera',
    lnSize.median = mean(lnSize.median),
    lnLife.median = mean(lnLife.median),
    lnSize.low = mean(lnSize.low),
    lnLife.low = mean(lnLife.low),
    lnSize.high = mean(lnSize.high),
    lnLife.high = mean(lnLife.high),
    lnK1 = mean(lnK1),
    lnK2 = mean(lnK2),
    log2CancerSucceptabilityChange = mean(log2CancerSucceptabilityChange)
  )
tr.RICR.yangochiroptera <- tr.RICR.chiroptera %>%
  tidytree::tree_subset(node.yangochiroptera, levels_back = 0) %>%
  as_tibble %>% 
  summarize(
    label='Yangochiroptera',
    lnSize.median = mean(lnSize.median),
    lnLife.median = mean(lnLife.median),
    lnSize.low = mean(lnSize.low),
    lnLife.low = mean(lnLife.low),
    lnSize.high = mean(lnSize.high),
    lnLife.high = mean(lnLife.high),
    lnK1 = mean(lnK1),
    lnK2 = mean(lnK2),
    log2CancerSucceptabilityChange = mean(log2CancerSucceptabilityChange)
  )

tr.RICR.summary <- 
  bind_rows(
    tr.RICR.myotis,
    tr.RICR.vespertilionidae,
    tr.RICR.molossidae,
    tr.RICR.phyllostomidae,
    tr.RICR.yinpterochiroptera,
    tr.RICR.yangochiroptera,
  )


phyloOrder <- p.tr.myotis$data %>% 
  select(label, y) %>% 
  arrange(desc(y)) %>% 
  pull(label) %>% 
  c(tr.RICR.summary$label) %>% 
  str_replace_all("_", " ") %>% 
  rev

tbl.RICR.myotis.withSummary <- 
  tbl.RICR.myotis2 %>% 
  select(label, lnSize.median, lnLife.median, lnSize.low, lnLife.low, lnSize.high, lnLife.high, lnK1, lnK2, log2CancerSucceptabilityChange) %>% 
  bind_rows(tr.RICR.summary) %>% 
  mutate(label=factor(label, levels=phyloOrder)) %>% 
  arrange(label)

```

```{r RICR with Summarized Data - Myotis}
p.RICR.myotis.sum <- tbl.RICR.myotis.withSummary %>% 
  ggplot(
    aes(
      y=label,
      x=lnK1
      )
  ) +
  geom_rect(
    aes(
      ymin=factor("Myotis", levels=phyloOrder),
      ymax=factor("Yangochiroptera", levels=phyloOrder),
      xmin=-Inf, 
      xmax=Inf
    ), 
    color='beige',
    fill='beige'
  ) + 
  geom_segment(
    aes(y=label, yend=label,
        x=lnK2, xend=lnK1,
        color=log2CancerSucceptabilityChange),
    arrow = arrow(length = unit(0.1, 'cm'),type='closed')
  ) + 
  geom_point(aes(x=lnK2), size=2, shape="|") +
  scale_color_viridis_c(
    option = 'D',
    guide = guide_colorbar(
      title="RICR",
      title.theme =  element_text(size = 6, face = "bold", colour = "black"),
      title.position = "top",
      title.hjust = 0.5
    )
  ) +
  labs(
    x="Cancer Risk",
    y="Node"
  ) + 
  theme_pubclean()+
  labs_pubr() + 
  guides(
    shape = guide_legend()
  ) +
  theme(
    text = element_text(face = "plain", 
                        colour = "black", lineheight = 0.9, 
                        hjust = 0.5, vjust = 0.5, angle = 0, margin = margin(), 
                        debug = FALSE), 
    axis.text = element_text(size = 6, 
                               colour = "black", face = "bold"),
    axis.title = element_text(size = 8, 
                              colour = "black", face = "bold"),
    plot.title = element_text(size = 8, 
                              colour = "black", lineheight = 1, face = "bold"), 
    legend.text = element_text(size = 6, 
                               face = "plain", colour = "black"),
    legend.position = "bottom"
  )

p.RICR.myotis.sum
```

```{r Body Size with Summarized Data - Myotis}
p.bodysize.myotis.sum <- tbl.RICR.myotis.withSummary %>% 
  ggplot(
    aes(
      y=label,
      x=lnSize.median, 
      xmin=lnSize.low,
      xmax=lnSize.high
      )
  ) +
  geom_rect(
    aes(
      ymin=factor("Myotis", levels=phyloOrder),
      ymax=factor("Yangochiroptera", levels=phyloOrder),
      xmin=-Inf, 
      xmax=Inf
    ), 
    color='beige',
    fill='beige'
  ) + 
  geom_pointrange(size=0.5, stroke=0.1) +
  geom_point(aes(color=lnSize.median), size=0.5) +
  scale_color_distiller(limits=c(size.scale.expanded.min, size.scale.expanded.max), 
                        palette = "Blues", 
                        direction = 1,
                        guide = guide_colorbar(
                          title="Body size (log)",
                          title.theme =  element_text(size = 6, face = "bold", colour = "black"),
                          title.position = "top",
                          title.hjust = 0.5
                          )
                        ) +
  labs(
    x="Body size (log)",
    y="Node"
  ) + 
  theme_pubr()+
  labs_pubr() + 
  theme(
    text = element_text(face = "plain", 
                        colour = "black", lineheight = 0.9, 
                        hjust = 0.5, vjust = 0.5, angle = 0, margin = margin(), 
                        debug = FALSE), 
    axis.text = element_text(size = 6, 
                               colour = "black", face = "bold"),
    axis.title = element_text(size = 8, 
                              colour = "black", face = "bold"),
    plot.title = element_text(size = 8, 
                              colour = "black", lineheight = 1, face = "bold"), 
    legend.text = element_text(size = 6, 
                               face = "plain", colour = "black"),
    legend.position = "bottom"
  )
p.bodysize.myotis.sum
```

```{r lifespan with summarized data - Myotis}
p.lifespan.myotis.sum <- tbl.RICR.myotis.withSummary %>% 
  mutate(
    life.median = exp(lnLife.median),
    life.low = exp(lnLife.low),
    life.high = exp(lnLife.high)
  ) %>% 
  ggplot(
    aes(
      y=label,
      x=life.median, 
      xmin=life.low,
      xmax=life.high
      )
  ) +
  geom_rect(
    aes(
      ymin=factor("Myotis", levels=phyloOrder),
      ymax=factor("Yangochiroptera", levels=phyloOrder),
      xmin=-Inf, 
      xmax=Inf
    ), 
    color='beige',
    fill='beige'
  ) + 
  geom_pointrange(size=0.5, stroke=0.5) +
  geom_point(aes(color=life.median), size=0.5) +
  scale_color_distiller(
    palette = "Reds", direction = 1,
    guide = guide_colorbar(
      title="Lifespan (yrs)",
      title.theme =  element_text(size = 6, face = "bold", colour = "black"),
      title.position = "top",
      title.hjust = 0.5
    )
  ) + 
  labs(
    x="Lifespan (log)",
    y="Node"
  ) + 
  theme_pubr()+
  labs_pubr() + 
  theme(
    text = element_text(face = "plain", 
                        colour = "black", lineheight = 0.9, 
                        hjust = 0.5, vjust = 0.5, angle = 0, margin = margin(), 
                        debug = FALSE), 
    axis.text = element_text(size = 6, 
                               colour = "black", face = "bold"),
    axis.title = element_text(size = 8, 
                              colour = "black", face = "bold"),
    plot.title = element_text(size = 8, 
                              colour = "black", lineheight = 1, face = "bold"), 
    legend.text = element_text(size = 6, 
                               face = "plain", colour = "black"),
    legend.position = "bottom"
  )
p.lifespan.myotis.sum
```

```{r Myotis+Summary Size-Life-RICR fig}

fig.myotis.sizelifericr.sum <- (
  (
    p.tr.myotis
  ) | 
  (
    (p.bodysize.myotis.sum + 
       # theme(legend.position = 'left', legend.direction = 'vertical', legend.title.align = 0)
       theme(legend.position = 'none')
     ) / 
    (p.lifespan.myotis.sum + 
       # theme(legend.position = 'left', legend.direction = 'vertical', legend.title.align = 0)
       theme(legend.position = 'none')
     ) / 
    (p.RICR.myotis.sum + 
       # theme(legend.position = 'left', legend.direction = 'vertical', legend.title.align = 0)
       theme(legend.position = 'none')
     )
  ) 
) +
    # guide_area()  + 
  plot_layout(width=c(1,2))+
  plot_annotation(tag_levels = 'A') & 
  theme(legend.box='vertical',
        legend.direction = 'vertical',
        legend.key.height = unit(0.3, 'in'),
        legend.key.width = unit(0.25, 'in'),
        legend.key.size = unit(0.25, 'in'),
        # axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.tag = element_text(size = 8, face = 'bold'))

fig.myotis.sizelifericr.sum

ggsave(
  '../output/draft_figs/Myotis_size_life_RICR_upham_withSummary.pdf', 
  plot=fig.myotis.sizelifericr.sum,
  width = 7,
  height = 8.5,
  units = 'in',
  dpi=300
)
```
